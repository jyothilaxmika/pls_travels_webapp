{% extends "base.html" %}

{% block title %}{{ title }} - PLS TRAVELS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card">
                <div class="card-header bg-warning bg-opacity-25">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>{{ title }}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control") }}
                            {% if form.name.errors %}
                                <div class="text-danger small">
                                    {% for error in form.name.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows="3") }}
                            {% if form.description.errors %}
                                <div class="text-danger small">
                                    {% for error in form.description.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.branch_id.label(class="form-label") }}
                                    {{ form.branch_id(class="form-select") }}
                                    {% if form.branch_id.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.branch_id.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.shift_pattern.label(class="form-label") }}
                                    {{ form.shift_pattern(class="form-select", onchange="updateDaysField()") }}
                                    {% if form.shift_pattern.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.shift_pattern.errors %}
                                                <div>{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="days-field">
                            {{ form.days_of_week.label(class="form-label") }}
                            {{ form.days_of_week(class="form-control") }}
                            {% if form.days_of_week.errors %}
                                <div class="text-danger small">
                                    {% for error in form.days_of_week.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="mt-2">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(1)">Mon</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(2)">Tue</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(3)">Wed</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(4)">Thu</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(5)">Fri</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(6)">Sat</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDay(7)">Sun</button>
                                </div>
                                <small class="text-muted d-block mt-1">Click days to toggle or enter manually</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.default_shift_type.label(class="form-label") }}
                            {{ form.default_shift_type(class="form-select") }}
                            {% if form.default_shift_type.errors %}
                                <div class="text-danger small">
                                    {% for error in form.default_shift_type.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.template_assignments.label(class="form-label") }}
                            {{ form.template_assignments(class="form-control", rows="6") }}
                            {% if form.template_assignments.errors %}
                                <div class="text-danger small">
                                    {% for error in form.template_assignments.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="showExampleJSON()">
                                    <i class="fas fa-lightbulb me-1"></i>Show Example
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_default(class="form-check-input") }}
                                {{ form.is_default.label(class="form-check-label") }}
                            </div>
                            <small class="text-muted">Sets this as the default template for the selected branch</small>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning flex-fill">
                                <i class="fas fa-save me-2"></i>Save Template
                            </button>
                            <a href="{{ url_for('admin.assignment_templates') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateDaysField() {
    const shiftPattern = document.getElementById('shift_pattern').value;
    const daysField = document.getElementById('days-field');
    
    if (shiftPattern === 'weekly') {
        daysField.style.display = 'block';
    } else if (shiftPattern === 'daily') {
        daysField.style.display = 'none';
        document.getElementById('days_of_week').value = '1,2,3,4,5,6,7';
    } else {
        daysField.style.display = 'block';
    }
}

function toggleDay(dayNumber) {
    const input = document.getElementById('days_of_week');
    let days = input.value ? input.value.split(',').map(d => parseInt(d.trim())).filter(d => d) : [];
    
    if (days.includes(dayNumber)) {
        days = days.filter(d => d !== dayNumber);
    } else {
        days.push(dayNumber);
    }
    
    days.sort((a, b) => a - b);
    input.value = days.join(',');
    
    updateDayButtons();
}

function updateDayButtons() {
    const input = document.getElementById('days_of_week');
    const days = input.value ? input.value.split(',').map(d => parseInt(d.trim())).filter(d => d) : [];
    
    for (let i = 1; i <= 7; i++) {
        const button = document.querySelector(`button[onclick="toggleDay(${i})"]`);
        if (days.includes(i)) {
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-warning');
        } else {
            button.classList.remove('btn-warning');
            button.classList.add('btn-outline-secondary');
        }
    }
}

function showExampleJSON() {
    const example = `[
  {
    "driver_id": 1,
    "vehicle_id": 1,
    "shift_type": "morning",
    "priority": "high"
  },
  {
    "driver_id": 2,
    "vehicle_id": 2,
    "shift_type": "evening",
    "priority": "normal"
  }
]`;
    
    document.getElementById('template_assignments').value = example;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateDaysField();
    updateDayButtons();
});
</script>
{% endblock %}