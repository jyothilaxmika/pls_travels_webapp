{% extends "base.html" %}

{% block title %}{{ driver.full_name }} - Driver Details - PLS TRAVELS{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{{ url_for('admin.drivers') }}" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h4><i class="fas fa-user me-1"></i>{{ driver.full_name }}</h4>
        </div>
    </div>
    <div>
        {% if driver.status.value == 'active' %}
        <span class="badge bg-success fs-6">Active</span>
        {% elif driver.status.value == 'pending' %}
        <span class="badge bg-warning fs-6">Pending Approval</span>
        {% elif driver.status.value == 'rejected' %}
        <span class="badge bg-danger fs-6">Rejected</span>
        {% elif driver.status.value == 'suspended' %}
        <span class="badge bg-danger fs-6">Blocked</span>
        {% elif driver.status.value == 'terminated' %}
        <span class="badge bg-dark fs-6">Terminated</span>
        {% else %}
        <span class="badge bg-secondary fs-6">{{ driver.status.value.title() }}</span>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Personal Information -->
    <div class="col-lg-8">
        <!-- Driver Statistics Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center card-compact">
                    <div class="card-body py-3">
                        <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                        <h5 class="mb-1">{{ total_duties }}</h5>
                        <small class="text-muted">Total Duties</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center card-compact">
                    <div class="card-body py-3">
                        <i class="fas fa-rupee-sign fa-2x text-success mb-2"></i>
                        <h5 class="mb-1">₹{{ "{:,.0f}".format(total_earnings) }}</h5>
                        <small class="text-muted">Total Earnings</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center card-compact">
                    <div class="card-body py-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h5 class="mb-1">₹{{ "{:,.0f}".format(total_penalties) }}</h5>
                        <small class="text-muted">Total Penalties</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center card-compact">
                    <div class="card-body py-3">
                        <i class="fas fa-money-bill-wave fa-2x text-info mb-2"></i>
                        <h5 class="mb-1">₹{{ "{:,.0f}".format(net_earnings) }}</h5>
                        <small class="text-muted">Net Earnings</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-user-circle me-2"></i>
                <h5 class="mb-0">Personal Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Full Name:</strong></td>
                                <td>{{ driver.full_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Username:</strong></td>
                                <td>{{ driver.user.username }}</td>
                            </tr>
                            <tr>
                                <td><strong>Phone:</strong></td>
                                <td>{{ driver.phone }}</td>
                            </tr>
                            <tr>
                                <td><strong>Email:</strong></td>
                                <td>{{ driver.user.email }}</td>
                            </tr>
                            <tr>
                                <td><strong>Date of Birth:</strong></td>
                                <td>{{ driver.date_of_birth.strftime('%Y-%m-%d') if driver.date_of_birth else 'Not provided' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>Branch:</strong></td>
                                <td>{{ driver.branch.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Address:</strong></td>
                                <td>{{ driver.address or 'Not provided' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Joined Date:</strong></td>
                                <td>{{ driver.created_at.strftime('%Y-%m-%d') }}</td>
                            </tr>
                            <tr>
                                <td><strong>Total Earnings:</strong></td>
                                <td class="text-success"><strong>₹{{ "{:,.2f}".format(driver.total_earnings) }}</strong></td>
                            </tr>
                            {% if driver.current_vehicle %}
                            <tr>
                                <td><strong>Current Vehicle:</strong></td>
                                <td>{{ driver.current_vehicle.registration_number }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- CRUD Documents Showcase -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-folder-open me-2"></i>
                    <h5 class="mb-0">Documents Management</h5>
                </div>
                <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                    <i class="fas fa-plus me-1"></i>Add Document
                </button>
            </div>
            <div class="card-body">
                <!-- Document Management Tabs -->
                <ul class="nav nav-tabs" id="documentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="identity-tab" data-bs-toggle="tab" data-bs-target="#identity" type="button" role="tab">
                            <i class="fas fa-id-card me-1"></i>Identity Documents
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="financial-tab" data-bs-toggle="tab" data-bs-target="#financial" type="button" role="tab">
                            <i class="fas fa-university me-1"></i>Financial Documents
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="additional-tab" data-bs-toggle="tab" data-bs-target="#additional" type="button" role="tab">
                            <i class="fas fa-file-alt me-1"></i>Additional Documents
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="documentTabContent">
                    <!-- Identity Documents Tab -->
                    <div class="tab-pane fade show active" id="identity" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="document-card border rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-id-card text-primary me-2"></i>Aadhar Card
                                                {% if driver.aadhar_verified %}
                                                    <span class="badge bg-success ms-2">Verified</span>
                                                {% else %}
                                                    <span class="badge bg-warning ms-2">Pending</span>
                                                {% endif %}
                                            </h6>
                                            <p class="text-muted mb-2">{{ driver.aadhar_number or 'Number not provided' }}</p>
                                            {% if driver.aadhar_verified_at %}
                                                <small class="text-success">Verified on {{ driver.aadhar_verified_at.strftime('%Y-%m-%d') }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="viewDocument('aadhar', '{{ driver.aadhar_document }}')">
                                                    <i class="fas fa-eye me-2"></i>View
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="editDocument('aadhar', {{ driver.id }})">
                                                    <i class="fas fa-edit me-2"></i>Edit
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="toggleVerification('aadhar', {{ driver.id }}, {{ 'true' if driver.aadhar_verified else 'false' }})">
                                                    <i class="fas fa-{% if driver.aadhar_verified %}times{% else %}check{% endif %} me-2"></i>
                                                    {% if driver.aadhar_verified %}Mark Unverified{% else %}Mark Verified{% endif %}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument('aadhar', {{ driver.id }})">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    {% if driver.aadhar_document %}
                                        <div class="document-preview mt-2">
                                            <img src="/uploads/{{ driver.aadhar_document }}" class="img-fluid rounded cursor-pointer" alt="Aadhar Document" onclick="viewDocument('aadhar', '{{ driver.aadhar_document }}')" style="max-height: 120px;">
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted py-3 bg-light rounded">
                                            <i class="fas fa-upload fa-2x mb-2"></i>
                                            <p class="mb-0">No document uploaded</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="document-card border rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">
                                                <i class="fas fa-id-badge text-info me-2"></i>Driving License
                                                {% if driver.license_verified %}
                                                    <span class="badge bg-success ms-2">Verified</span>
                                                {% else %}
                                                    <span class="badge bg-warning ms-2">Pending</span>
                                                {% endif %}
                                            </h6>
                                            <p class="text-muted mb-1">{{ driver.license_number or 'Number not provided' }}</p>
                                            <small class="text-muted">{{ driver.license_type or 'Type not specified' }}</small>
                                            {% if driver.license_expiry %}
                                                <p class="text-warning mb-1">Expires: {{ driver.license_expiry.strftime('%Y-%m-%d') }}</p>
                                            {% endif %}
                                            {% if driver.license_verified_at %}
                                                <small class="text-success d-block">Verified on {{ driver.license_verified_at.strftime('%Y-%m-%d') }}</small>
                                            {% endif %}
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="viewDocument('license', '{{ driver.license_document }}')">
                                                    <i class="fas fa-eye me-2"></i>View
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="editDocument('license', {{ driver.id }})">
                                                    <i class="fas fa-edit me-2"></i>Edit
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="toggleVerification('license', {{ driver.id }}, {{ 'true' if driver.license_verified else 'false' }})">
                                                    <i class="fas fa-{% if driver.license_verified %}times{% else %}check{% endif %} me-2"></i>
                                                    {% if driver.license_verified %}Mark Unverified{% else %}Mark Verified{% endif %}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument('license', {{ driver.id }})">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    {% if driver.license_document %}
                                        <div class="document-preview mt-2">
                                            <img src="/uploads/{{ driver.license_document }}" class="img-fluid rounded cursor-pointer" alt="License Document" onclick="viewDocument('license', '{{ driver.license_document }}')" style="max-height: 120px;">
                                        </div>
                                    {% else %}
                                        <div class="text-center text-muted py-3 bg-light rounded">
                                            <i class="fas fa-upload fa-2x mb-2"></i>
                                            <p class="mb-0">No document uploaded</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Documents Tab -->
                    <div class="tab-pane fade" id="financial" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Bank Account Details</h6>
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>Bank Name:</strong></td>
                                            <td>{{ driver.bank_name or 'Not provided' }}</td>
                                            <td><button class="btn btn-sm btn-outline-warning" onclick="editBankDetails({{ driver.id }})"><i class="fas fa-edit"></i></button></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Account Number:</strong></td>
                                            <td>{{ driver.account_number or 'Not provided' }}</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>IFSC Code:</strong></td>
                                            <td>{{ driver.ifsc_code or 'Not provided' }}</td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Account Holder:</strong></td>
                                            <td>{{ driver.account_holder_name or 'Not provided' }}</td>
                                            <td></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Documents Tab -->
                    <div class="tab-pane fade" id="additional" role="tabpanel">
                        <div class="mt-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="document-card border rounded p-3 mb-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    <i class="fas fa-user-circle text-success me-2"></i>Profile Photo
                                                </h6>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="viewDocument('profile', '{{ driver.profile_photo }}')">
                                                        <i class="fas fa-eye me-2"></i>View
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="editDocument('profile', {{ driver.id }})">
                                                        <i class="fas fa-edit me-2"></i>Edit
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteDocument('profile', {{ driver.id }})">
                                                        <i class="fas fa-trash me-2"></i>Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        {% if driver.profile_photo %}
                                            <div class="document-preview mt-2">
                                                <img src="/uploads/{{ driver.profile_photo }}" class="img-fluid rounded cursor-pointer" alt="Profile Photo" onclick="viewDocument('profile', '{{ driver.profile_photo }}')" style="max-height: 120px;">
                                            </div>
                                        {% else %}
                                            <div class="text-center text-muted py-3 bg-light rounded">
                                                <i class="fas fa-upload fa-2x mb-2"></i>
                                                <p class="mb-0">No photo uploaded</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Transaction Ledger -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="fas fa-receipt me-2"></i>
                    <h5 class="mb-0">Financial Transaction Ledger</h5>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" onchange="filterTransactions(this.value)">
                        <option value="all">All Transactions</option>
                        <option value="earnings">Earnings</option>
                        <option value="deductions">Deductions</option>
                        <option value="advances">Advances</option>
                        <option value="penalties">Penalties</option>
                    </select>
                    <button type="button" class="btn btn-warning btn-sm" onclick="showDateRangePicker()">
                        <i class="fas fa-calendar me-1"></i>Filter Dates
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Financial Summary Cards -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card bg-success bg-opacity-25">
                            <div class="card-body text-center py-2">
                                <h6 class="mb-1 text-success">₹{{ "{:,.0f}".format(total_earnings) }}</h6>
                                <small class="text-muted">Total Earnings</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger bg-opacity-25">
                            <div class="card-body text-center py-2">
                                <h6 class="mb-1 text-danger">₹{{ "{:,.0f}".format(total_penalties) }}</h6>
                                <small class="text-muted">Total Penalties</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning bg-opacity-25">
                            <div class="card-body text-center py-2">
                                <h6 class="mb-1 text-warning">₹0</h6>
                                <small class="text-muted">Advances</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info bg-opacity-25">
                            <div class="card-body text-center py-2">
                                <h6 class="mb-1 text-info">₹{{ "{:,.0f}".format(net_earnings) }}</h6>
                                <small class="text-muted">Net Balance</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Table -->
                <div class="table-responsive">
                    <table class="table table-sm" id="transactionTable">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Transaction Type</th>
                                <th>Description</th>
                                <th>Reference</th>
                                <th class="text-end">Debit</th>
                                <th class="text-end">Credit</th>
                                <th class="text-end">Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <!-- Sample Transaction Data -->
                            {% set running_balance = 0 %}
                            {% for duty in recent_duties %}
                                {% if duty.driver_earnings %}
                                    {% set running_balance = running_balance + duty.driver_earnings %}
                                    <tr class="transaction-row" data-type="earnings">
                                        <td>{{ duty.start_time.strftime('%Y-%m-%d') if duty.start_time else 'N/A' }}</td>
                                        <td><span class="badge bg-success">EARNINGS</span></td>
                                        <td>Duty Earnings - {{ duty.vehicle.registration_number if duty.vehicle else 'N/A' }}</td>
                                        <td><small>DUTY-{{ duty.id }}</small></td>
                                        <td class="text-end">-</td>
                                        <td class="text-end text-success">₹{{ "{:,.2f}".format(duty.driver_earnings) }}</td>
                                        <td class="text-end"><strong>₹{{ "{:,.2f}".format(running_balance) }}</strong></td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-info" onclick="viewTransaction('duty', {{ duty.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="editTransaction('duty', {{ duty.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            
                            {% for penalty in penalties %}
                                {% set running_balance = running_balance - penalty.amount %}
                                <tr class="transaction-row" data-type="penalties">
                                    <td>{{ penalty.applied_at.strftime('%Y-%m-%d') if penalty.applied_at else 'N/A' }}</td>
                                    <td><span class="badge bg-danger">PENALTY</span></td>
                                    <td>{{ penalty.reason }}</td>
                                    <td><small>PEN-{{ penalty.id }}</small></td>
                                    <td class="text-end text-danger">₹{{ "{:,.2f}".format(penalty.amount) }}</td>
                                    <td class="text-end">-</td>
                                    <td class="text-end"><strong>₹{{ "{:,.2f}".format(running_balance) }}</strong></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-info" onclick="viewTransaction('penalty', {{ penalty.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="removeTransaction('penalty', {{ penalty.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Add Transaction Button -->
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                        <i class="fas fa-plus me-2"></i>Add Manual Transaction
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Duties -->
        {% if recent_duties %}
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-clipboard-list me-2"></i>
                <h5 class="mb-0">Recent Duties</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Vehicle</th>
                                <th>Duration</th>
                                <th>Distance</th>
                                <th>Earnings</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for duty in recent_duties %}
                            <tr>
                                <td>{{ duty.start_time.strftime('%Y-%m-%d') }}</td>
                                <td>{{ duty.vehicle.registration_number if duty.vehicle else 'N/A' }}</td>
                                <td>
                                    {% if duty.end_time %}
                                    {{ ((duty.end_time - duty.start_time).seconds // 3600) }}h {{ (((duty.end_time - duty.start_time).seconds % 3600) // 60) }}m
                                    {% else %}
                                    In Progress
                                    {% endif %}
                                </td>
                                <td>{{ "{:.1f}".format(duty.distance_km) if duty.distance_km else '0' }} km</td>
                                <td class="text-success">₹{{ "{:,.2f}".format(duty.driver_earnings) }}</td>
                                <td>
                                    {% if duty.status == 'active' %}
                                    <span class="badge bg-primary">Active</span>
                                    {% elif duty.status == 'completed' %}
                                    <span class="badge bg-success">Completed</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ duty.status.value.title() }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Vehicle Assignments History -->
        {% if assignments %}
        <div class="card card-compact">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-calendar-alt me-2"></i>
                <h6 class="mb-0">Vehicle Assignment History</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th><small>Vehicle</small></th>
                                <th><small>Period</small></th>
                                <th><small>Shift</small></th>
                                <th><small>Status</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr>
                                <td><small><strong>{{ assignment.assignment_vehicle.registration_number }}</strong></small></td>
                                <td><small>
                                    {{ assignment.start_date.strftime('%m-%d') }}
                                    {% if assignment.end_date %}
                                    to {{ assignment.end_date.strftime('%m-%d') }}
                                    {% else %}
                                    <span class="text-primary">(Ongoing)</span>
                                    {% endif %}
                                </small></td>
                                <td><small>{{ assignment.shift_type.replace('_', ' ').title() }}</small></td>
                                <td>
                                    {% if assignment.status == 'active' %}
                                        <span class="badge badge-sm bg-success">Active</span>
                                    {% elif assignment.status == 'scheduled' %}
                                        <span class="badge badge-sm bg-primary">Scheduled</span>
                                    {% else %}
                                        <span class="badge badge-sm bg-secondary">{{ assignment.status.value.title() }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Penalties -->
        {% if penalties %}
        <div class="card card-compact">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <h6 class="mb-0">Penalties History</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th><small>Date</small></th>
                                <th><small>Amount</small></th>
                                <th><small>Reason</small></th>
                                <th><small>Applied By</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for penalty in penalties %}
                            <tr>
                                <td><small>{{ penalty.applied_at.strftime('%m-%d') }}</small></td>
                                <td><small class="text-danger">₹{{ "{:,.0f}".format(penalty.amount) }}</small></td>
                                <td><small>{{ penalty.reason }}</small></td>
                                <td><small>{{ penalty.applied_by_user.username if penalty.applied_by_user else 'System' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Sidebar -->
    <div class="col-lg-4">
        <!-- Profile Photo -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Profile Photo</h5>
            </div>
            <div class="card-body text-center">
                {% if driver.profile_photo %}
                <img src="/uploads/{{ driver.profile_photo }}" class="img-fluid rounded-circle mb-3" style="max-width: 150px; height: 150px; object-fit: cover;" alt="Profile Photo">
                {% else %}
                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto mb-3" style="width: 150px; height: 150px;">
                    <i class="fas fa-user fa-4x text-white"></i>
                </div>
                {% endif %}
                <h6>{{ driver.full_name }}</h6>
                <p class="text-muted">{{ driver.user.role.value.title() }}</p>
            </div>
        </div>

        <!-- Assets -->
        {% if assets %}
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-tools me-2"></i>
                <h5 class="mb-0">Assigned Assets</h5>
            </div>
            <div class="card-body">
                {% for asset in assets %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ asset.asset_type.value.title() }}</strong><br>
                        <small class="text-muted">{{ asset.asset_id }}</small>
                    </div>
                    <span class="badge bg-{% if asset.status.value == 'assigned' %}success{% elif asset.status.value == 'returned' %}secondary{% else %}warning{% endif %}">
                        {{ asset.status.value.title() }}
                    </span>
                </div>
                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Driver Management Actions -->
        {% if driver.status.value == 'pending' %}
        <div class="card mb-3">
            <div class="card-header bg-warning">
                <h5 class="mb-0">Approval Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <form method="POST" action="{{ url_for('admin.approve_driver', driver_id=driver.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success w-100" onclick="return confirm('Approve this driver?')">
                            <i class="fas fa-check me-2"></i>Approve Driver
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('admin.reject_driver', driver_id=driver.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger w-100" onclick="return confirm('Reject this driver?')">
                            <i class="fas fa-times me-2"></i>Reject Driver
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Block/Unblock Actions -->
        {% if driver.status.value in ['active', 'suspended'] %}
        <div class="card">
            <div class="card-header {% if driver.status.value == 'suspended' %}bg-danger text-white{% else %}bg-info text-white{% endif %}">
                <h5 class="mb-0">Driver Control</h5>
            </div>
            <div class="card-body">
                {% if driver.status.value == 'suspended' %}
                    <div class="alert alert-danger mb-3">
                        <i class="fas fa-ban me-2"></i>
                        <strong>Driver is currently BLOCKED</strong>
                        {% if driver.suspension_reason %}
                            <br><small>Reason: {{ driver.suspension_reason }}</small>
                        {% endif %}
                        {% if driver.suspended_at %}
                            <br><small>Blocked on: {{ driver.suspended_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-success w-100" onclick="unblockDriver({{ driver.id }})">
                            <i class="fas fa-unlock me-2"></i>Unblock Driver
                        </button>
                    </div>
                {% else %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Driver is currently ACTIVE</strong>
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-danger w-100" onclick="showBlockDriverModal({{ driver.id }}, '{{ driver.full_name }}')">
                            <i class="fas fa-ban me-2"></i>Block Driver
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Document Modal -->
<div class="modal fade" id="addDocumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDocumentForm" enctype="multipart/form-data">
                    <input type="hidden" name="driver_id" value="{{ driver.id }}">
                    <div class="mb-3">
                        <label class="form-label">Document Type</label>
                        <select name="document_type" class="form-select" required>
                            <option value="">Select Document Type</option>
                            <option value="aadhar">Aadhar Card</option>
                            <option value="license">Driving License</option>
                            <option value="profile">Profile Photo</option>
                            <option value="insurance">Insurance Document</option>
                            <option value="medical">Medical Certificate</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Document Number (if applicable)</label>
                        <input type="text" name="document_number" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Upload Document</label>
                        <input type="file" name="document_file" class="form-control" accept=".jpg,.jpeg,.png,.pdf" required>
                        <small class="text-muted">Supported formats: JPG, PNG, PDF (Max 16MB)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitDocumentForm()">
                    <i class="fas fa-save me-2"></i>Save Document
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Manual Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <input type="hidden" name="driver_id" value="{{ driver.id }}">
                    <div class="mb-3">
                        <label class="form-label">Transaction Type</label>
                        <select name="transaction_type" class="form-select" required>
                            <option value="">Select Type</option>
                            <option value="advance">Advance Payment</option>
                            <option value="bonus">Bonus</option>
                            <option value="penalty">Penalty</option>
                            <option value="reimbursement">Reimbursement</option>
                            <option value="deduction">Deduction</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <input type="number" name="amount" class="form-control" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" name="description" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference Number</label>
                        <input type="text" name="reference" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Transaction Date</label>
                        <input type="date" name="transaction_date" class="form-control" value="{{ datetime.now().strftime('%Y-%m-%d') }}" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitTransactionForm()">
                    <i class="fas fa-save me-2"></i>Add Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentViewerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Document Viewer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="documentImage" src="" class="img-fluid" alt="Document">
            </div>
        </div>
    </div>
</div>

<!-- Block Driver Modal -->
<div class="modal fade" id="blockDriverModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Block Driver</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Blocking this driver will:
                    <ul class="mb-0 mt-2">
                        <li>End all active duties immediately</li>
                        <li>Complete all active vehicle assignments</li>
                        <li>Prevent the driver from starting new duties</li>
                        <li>Block access to the driver portal</li>
                    </ul>
                </div>
                <form id="blockDriverForm">
                    <input type="hidden" id="blockDriverId" name="driver_id">
                    <div class="mb-3">
                        <label class="form-label">Driver Name</label>
                        <input type="text" id="blockDriverName" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason for Blocking <span class="text-danger">*</span></label>
                        <select class="form-select" name="reason" required>
                            <option value="">Select a reason</option>
                            <option value="Violation of company policy">Violation of company policy</option>
                            <option value="Safety concerns">Safety concerns</option>
                            <option value="Document verification issues">Document verification issues</option>
                            <option value="Customer complaints">Customer complaints</option>
                            <option value="Vehicle damage">Vehicle damage</option>
                            <option value="Administrative decision">Administrative decision</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Notes (Optional)</label>
                        <textarea class="form-control" name="additional_notes" rows="3" placeholder="Provide additional details about the blocking reason..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmBlockDriver()">
                    <i class="fas fa-ban me-2"></i>Block Driver
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.document-card {
    transition: all 0.3s ease;
}
.document-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.cursor-pointer {
    cursor: pointer;
}
.card-compact .card-body {
    padding: 1rem;
}
.transaction-row {
    transition: background-color 0.2s;
}
.transaction-row:hover {
    background-color: rgba(255, 193, 7, 0.1);
}
</style>

<script>
// Document Management Functions
function viewDocument(type, filename) {
    if (filename) {
        document.getElementById('documentImage').src = '/uploads/' + filename;
        const modal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
        modal.show();
    }
}

function editDocument(type, driverId) {
    // Open edit modal or redirect to edit page
    alert('Edit functionality for ' + type + ' document will be implemented');
}

function deleteDocument(type, driverId) {
    if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
        fetch(`/admin/drivers/${driverId}/documents/${type}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting document: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting document');
        });
    }
}

function toggleVerification(type, driverId, currentStatus) {
    const action = currentStatus === 'true' ? 'unverify' : 'verify';
    const confirmMsg = currentStatus === 'true' ? 'Mark this document as unverified?' : 'Mark this document as verified?';
    
    if (confirm(confirmMsg)) {
        fetch(`/admin/drivers/${driverId}/documents/${type}/${action}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating verification status: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating verification status');
        });
    }
}

function submitDocumentForm() {
    const form = document.getElementById('addDocumentForm');
    const formData = new FormData(form);
    
    // Add CSRF token to form data
    const csrfToken = getCSRFToken();
    if (csrfToken) {
        formData.append('csrf_token', csrfToken);
    }
    
    fetch('/admin/drivers/documents/add', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding document: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding document');
    });
}

// Financial Transaction Functions
function filterTransactions(type) {
    const rows = document.querySelectorAll('.transaction-row');
    rows.forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function showDateRangePicker() {
    const startDate = prompt('Enter start date (YYYY-MM-DD):');
    const endDate = prompt('Enter end date (YYYY-MM-DD):');
    
    if (startDate && endDate) {
        window.location.href = `{{ url_for('admin.view_driver', driver_id=driver.id) }}?start_date=${startDate}&end_date=${endDate}`;
    }
}

function viewTransaction(type, id) {
    alert('View transaction details for ' + type + ' ID: ' + id);
}

function editTransaction(type, id) {
    alert('Edit transaction for ' + type + ' ID: ' + id);
}

function removeTransaction(type, id) {
    if (confirm('Are you sure you want to remove this transaction?')) {
        fetch(`/admin/transactions/${type}/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error removing transaction: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing transaction');
        });
    }
}

function submitTransactionForm() {
    const form = document.getElementById('addTransactionForm');
    const formData = new FormData(form);
    
    // Add CSRF token to form data
    const csrfToken = getCSRFToken();
    if (csrfToken) {
        formData.append('csrf_token', csrfToken);
    }
    
    fetch('/admin/transactions/add', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error adding transaction: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding transaction');
    });
}

function editBankDetails(driverId) {
    alert('Edit bank details functionality will be implemented');
}

// Driver Block/Unblock Functions
function showBlockDriverModal(driverId, driverName) {
    document.getElementById('blockDriverId').value = driverId;
    document.getElementById('blockDriverName').value = driverName;
    const modal = new bootstrap.Modal(document.getElementById('blockDriverModal'));
    modal.show();
}

function confirmBlockDriver() {
    const form = document.getElementById('blockDriverForm');
    const formData = new FormData(form);
    const driverId = document.getElementById('blockDriverId').value;
    const reason = formData.get('reason');
    const additionalNotes = formData.get('additional_notes');
    
    if (!reason) {
        alert('Please select a reason for blocking the driver');
        return;
    }
    
    // Combine reason and additional notes
    let fullReason = reason;
    if (additionalNotes) {
        fullReason += ` - ${additionalNotes}`;
    }
    
    if (confirm('Are you sure you want to block this driver? This action will end all active duties and assignments immediately.')) {
        const blockFormData = new FormData();
        blockFormData.append('reason', fullReason);
        
        fetch(`/admin/drivers/${driverId}/block`, {
            method: 'POST',
            body: blockFormData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error blocking driver: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error blocking driver');
        });
    }
}

function unblockDriver(driverId) {
    if (confirm('Are you sure you want to unblock this driver? They will be able to access the system and start new duties.')) {
        fetch(`/admin/drivers/${driverId}/unblock`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error unblocking driver: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unblocking driver');
        });
    }
}
</script>
{% endblock %}