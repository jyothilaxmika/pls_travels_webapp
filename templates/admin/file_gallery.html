{% extends "base.html" %}

{% block title %}File Gallery - {{ category.title() }} - PLS TRAVELS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-images me-2"></i>{{ category.title() }} Gallery
        <span class="badge bg-secondary ms-2">{{ files.total }} files</span>
    </h2>
    <div>
        <a href="/admin/storage" class="btn btn-outline-info">
            <i class="fas fa-database me-2"></i>Storage Dashboard
        </a>
    </div>
</div>

<!-- Category Navigation -->
<div class="mb-4">
    <div class="btn-group" role="group">
        <a href="/storage/gallery/documents" 
           class="btn btn-{{ 'primary' if category == 'documents' else 'outline-primary' }}">
            <i class="fas fa-file-alt me-1"></i>Documents
        </a>
        <a href="/storage/gallery/photos" 
           class="btn btn-{{ 'primary' if category == 'photos' else 'outline-primary' }}">
            <i class="fas fa-images me-1"></i>Photos
        </a>
        <a href="/storage/gallery/captures" 
           class="btn btn-{{ 'primary' if category == 'captures' else 'outline-primary' }}">
            <i class="fas fa-camera me-1"></i>Captures
        </a>
        <a href="/storage/gallery/assets" 
           class="btn btn-{{ 'primary' if category == 'assets' else 'outline-primary' }}">
            <i class="fas fa-folder me-1"></i>Assets
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="user_filter" class="form-label">Filter by User ID</label>
                <input type="number" class="form-control" name="user_id" 
                       placeholder="Enter User ID" value="{{ user_filter or '' }}">
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search me-1"></i>Apply Filter
                </button>
                <a href="/storage/gallery/{{ category }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- File Gallery -->
<div class="row">
    {% for file in files.files %}
    <div class="col-md-3 mb-4">
        <div class="card h-100">
            <div class="card-body text-center">
                {% if file.content_type and file.content_type.startswith('image/') %}
                    <img src="/storage/file/{{ file.file_path }}" 
                         class="img-fluid rounded mb-3" 
                         style="max-height: 150px; cursor: pointer;"
                         onclick="showImageModal('/storage/file/{{ file.file_path }}', '{{ file.file_type or 'Image' }}')">
                {% elif file.content_type and file.content_type == 'application/pdf' %}
                    <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                {% else %}
                    <i class="fas fa-file fa-4x text-muted mb-3"></i>
                {% endif %}
                
                <h6 class="card-title">
                    {{ file.file_type.replace('_', ' ').title() if file.file_type else 'Document' }}
                </h6>
                
                <div class="text-muted mb-2">
                    <small>
                        <i class="fas fa-user me-1"></i>User: {{ file.user_id }}<br>
                        <i class="fas fa-calendar me-1"></i>{{ file.uploaded_at[:10] if file.uploaded_at else 'Unknown' }}<br>
                        <i class="fas fa-hdd me-1"></i>{{ "%.1f KB"|format((file.file_size or 0) / 1024) }}
                    </small>
                </div>
                
                {% if file.category == 'captures' and file.location %}
                <div class="text-info mb-2">
                    <small>
                        <i class="fas fa-map-marker-alt me-1"></i>Location Available
                    </small>
                </div>
                {% endif %}
            </div>
            
            <div class="card-footer">
                <div class="btn-group w-100">
                    <a href="/storage/file/{{ file.file_path }}" 
                       target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i>
                    </a>
                    <a href="/storage/file/{{ file.file_path }}" 
                       download class="btn btn-sm btn-outline-success">
                        <i class="fas fa-download"></i>
                    </a>
                    {% if current_user.role.name == 'ADMIN' %}
                    <button class="btn btn-sm btn-outline-info" 
                            onclick="showMetadata('{{ file.stored_filename }}', '{{ category }}')">
                        <i class="fas fa-info"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteFile('{{ file.stored_filename }}', '{{ category }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="text-center py-5">
            <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
            <h4 class="text-muted">No files found</h4>
            <p class="text-muted">{{ category.title() }} files will appear here when uploaded.</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if files.pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if files.page > 1 %}
            <li class="page-item">
                <a class="page-link" href="?page={{ files.page - 1 }}{% if user_filter %}&user_id={{ user_filter }}{% endif %}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>
        {% endif %}
        
        {% for i in range(1, files.pages + 1) %}
            {% if i == files.page %}
                <li class="page-item active">
                    <span class="page-link">{{ i }}</span>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ i }}{% if user_filter %}&user_id={{ user_filter }}{% endif %}">{{ i }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if files.page < files.pages %}
            <li class="page-item">
                <a class="page-link" href="?page={{ files.page + 1 }}{% if user_filter %}&user_id={{ user_filter }}{% endif %}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageModalImg" src="" class="img-fluid" alt="Image">
            </div>
        </div>
    </div>
</div>

<!-- Metadata Modal -->
<div class="modal fade" id="metadataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Metadata</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="metadataContent">
                <!-- Metadata loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

<script>
function showImageModal(src, title) {
    document.getElementById('imageModalImg').src = src;
    document.getElementById('imageModalTitle').textContent = title;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
}

function showMetadata(filename, category) {
    fetch(`/api/storage/file/${filename}/metadata?type=${category}`)
        .then(response => response.json())
        .then(data => {
            if (data.metadata) {
                let html = '<dl class="row">';
                for (const [key, value] of Object.entries(data.metadata)) {
                    html += `
                        <dt class="col-sm-4">${key.replace('_', ' ').toUpperCase()}</dt>
                        <dd class="col-sm-8">${typeof value === 'object' ? JSON.stringify(value) : value}</dd>
                    `;
                }
                html += '</dl>';
                document.getElementById('metadataContent').innerHTML = html;
            } else {
                document.getElementById('metadataContent').innerHTML = '<p class="text-muted">No metadata available</p>';
            }
            new bootstrap.Modal(document.getElementById('metadataModal')).show();
        })
        .catch(error => {
            document.getElementById('metadataContent').innerHTML = '<p class="text-danger">Error loading metadata</p>';
            new bootstrap.Modal(document.getElementById('metadataModal')).show();
        });
}

function deleteFile(filename, category) {
    if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
        fetch(`/api/storage/file/${filename}?type=${category}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting file: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting file: ' + error.message);
        });
    }
}
</script>
{% endblock %}