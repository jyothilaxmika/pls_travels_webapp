{% extends "base.html" %}

{% block title %}Vehicle Tracking & Heatmap - {{ super() }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.heat/dist/leaflet-heat.css" />
<style>
    #map {
        height: 70vh !important;
        min-height: 400px !important;
        width: 100% !important;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
    }
    
    .map-controls {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }
    
    /* Mobile-first responsive improvements */
    @media (max-width: 768px) {
        #map {
            height: 50vh;
            min-height: 300px;
        }
        
        .map-controls {
            padding: 0.75rem;
        }
        
        .map-controls .row {
            row-gap: 1rem;
        }
        
        .stats-number {
            font-size: 1.5rem !important;
        }
        
        .btn-group {
            width: 100% !important;
        }
        
        .btn-group .btn {
            flex: 1;
            font-size: 0.8rem;
        }
    }
    
    @media (max-width: 576px) {
        .map-controls {
            padding: 0.5rem;
        }
        
        .form-label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .btn-group .btn {
            padding: 0.375rem 0.25rem;
        }
    }
    
    .vehicle-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .vehicle-active {
        background-color: #28a745;
    }
    
    .vehicle-idle {
        background-color: #ffc107;
    }
    
    .vehicle-offline {
        background-color: #dc3545;
    }
    
    .legend {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 0.5rem;
        border: 1px solid #ddd;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
    }
    
    .stats-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .refresh-btn {
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .btn-toggle {
        margin: 0.2rem;
    }
    
    .btn-toggle.active {
        background-color: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Responsive Header -->
            <div class="row align-items-center mb-4">
                <div class="col-12 col-md-8">
                    <h1 class="h3 mb-2 mb-md-0">
                        <i class="fas fa-map-marked-alt text-primary"></i>
                        <span class="d-none d-sm-inline">Vehicle Tracking & Heatmap</span>
                        <span class="d-inline d-sm-none">Vehicle Tracking</span>
                    </h1>
                </div>
                <div class="col-12 col-md-4">
                    <div class="d-flex gap-2 justify-content-md-end">
                        <button id="refreshBtn" class="btn btn-outline-primary btn-sm flex-fill flex-md-grow-0">
                            <i class="fas fa-sync-alt"></i>
                            <span class="d-none d-sm-inline"> Refresh</span>
                        </button>
                        <button id="toggleHeatmap" class="btn btn-outline-warning btn-sm flex-fill flex-md-grow-0">
                            <i class="fas fa-fire"></i>
                            <span class="d-none d-sm-inline"> Heatmap</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-lg-9 mb-4">
            <!-- Responsive Map Controls -->
            <div class="map-controls">
                <div class="row g-3">
                    <div class="col-12 col-sm-6 col-md-3">
                        <label for="branchFilter" class="form-label">Branch:</label>
                        <select id="branchFilter" class="form-select form-select-sm">
                            <option value="">All Branches</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <label for="vehicleFilter" class="form-label">Vehicle:</label>
                        <select id="vehicleFilter" class="form-select form-select-sm" multiple size="1">
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.id }}">{{ vehicle.number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <label for="timeRange" class="form-label">Time Range:</label>
                        <select id="timeRange" class="form-select form-select-sm">
                            <option value="1">1 Hour</option>
                            <option value="6">6 Hours</option>
                            <option value="24" selected>24 Hours</option>
                            <option value="72">3 Days</option>
                            <option value="168">Week</option>
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-md-3">
                        <label class="form-label">Map View:</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle active" data-view="live">
                                <i class="fas fa-location-dot"></i><span class="d-none d-lg-inline"> Live</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle" data-view="heatmap">
                                <i class="fas fa-fire"></i><span class="d-none d-lg-inline"> Heat</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-toggle" data-view="paths">
                                <i class="fas fa-route"></i><span class="d-none d-lg-inline"> Paths</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map" style="height: 70vh; min-height: 400px; width: 100%; position: relative; z-index: 1; background-color: #f8f9fa;"></div>
        </div>

        <div class="col-12 col-lg-3">
            <!-- Mobile-optimized sidebar -->
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-1 g-3">
                <div class="col">
                    <!-- Statistics -->
                    <div class="stats-card">
                        <div class="stats-number" id="totalVehicles">0</div>
                        <div class="stats-label">Active Vehicles</div>
                    </div>
                </div>
                
                <div class="col">
                    <!-- Legend -->
                    <div class="legend">
                        <h6 class="mb-3">
                            <i class="fas fa-info-circle"></i> Legend
                        </h6>
                        <div class="legend-item">
                            <div class="legend-color vehicle-active"></div>
                            <span>Active (Moving)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color vehicle-idle"></div>
                            <span>Idle (Stopped)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color vehicle-offline"></div>
                            <span>Offline (No data)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Status Indicator -->
            <div class="row">
                <div class="col">
                    <div class="mb-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="mb-0">
                                <i class="fas fa-satellite-dish"></i> 
                                <span class="d-none d-sm-inline">Real-time Status</span>
                                <span class="d-inline d-sm-none">Status</span>
                            </h6>
                            <span id="connectionStatus" class="badge bg-secondary">Connecting...</span>
                        </div>
                        <small class="text-muted">WebSocket updates active</small>
                    </div>
                </div>
            </div>

            <!-- Mobile Location Sharing (for drivers on mobile) -->
            <div class="mb-3" id="mobileLocationPanel" style="display: none;">
                <div class="bg-light p-3 rounded">
                    <h6 class="mb-2">
                        <i class="fas fa-mobile-alt"></i> Share Your Location
                    </h6>
                    <button class="btn btn-success btn-sm w-100 mb-2" id="shareLocationBtn">
                        <i class="fas fa-location-arrow"></i> Start Sharing Location
                    </button>
                    <div id="locationStatus" class="small text-muted">
                        Location sharing disabled
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="mt-3">
                        <h6>
                            <i class="fas fa-truck"></i> 
                            <span class="d-none d-sm-inline">Vehicle Status</span>
                            <span class="d-inline d-sm-none">Vehicles</span>
                            <small class="text-muted d-block d-sm-inline" id="lastUpdate"></small>
                        </h6>
                        <div id="vehicleList" class="mt-2">
                            <!-- Vehicle list will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Details Modal -->
<div class="modal fade" id="vehicleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-truck"></i> Vehicle Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="vehicleModalBody">
                <!-- Vehicle details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="showPathBtn">Show Path</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO for real-time updates -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- Simple Map Test -->
<script>
console.log('Script starting to load...');

// Simple map initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - checking Leaflet...');
    
    if (typeof L === 'undefined') {
        console.error('Leaflet not loaded!');
        return;
    }
    
    console.log('Leaflet available, initializing map...');
    
    // Force map container to be visible
    const mapEl = document.getElementById('map');
    if (!mapEl) {
        console.error('Map container not found!');
        return;
    }
    
    console.log('Map container found, dimensions:', mapEl.getBoundingClientRect());
    
    // Simple map initialization
    try {
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        console.log('Leaflet map created successfully');
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        console.log('Tiles added to map');
        
        // Make globally accessible
        window.simpleMap = map;
        
        // Force resize
        setTimeout(() => {
            map.invalidateSize();
            console.log('Map invalidateSize called');
        }, 100);
        
    } catch (error) {
        console.error('Error creating map:', error);
    }
});

console.log('Script loaded completely');
</script>

<script>
class VehicleTracker {
    constructor() {
        console.log('VehicleTracker constructor started');
        this.map = null;
        this.markers = {};
        this.heatmapLayer = null;
        this.pathLayers = {};
        this.currentView = 'live';
        this.refreshInterval = null;
        this.socket = null;
        
        try {
            console.log('About to initialize map...');
            this.initMap();
            console.log('Map initialized, setting up event listeners...');
            this.setupEventListeners();
            console.log('Event listeners set up, initializing socket...');
            this.initSocket();
            console.log('Socket initialized, starting auto-refresh...');
            this.startAutoRefresh();
            console.log('Auto-refresh started, loading vehicle data...');
            this.loadVehicleData();
            console.log('VehicleTracker constructor completed successfully');
        } catch (error) {
            console.error('Error in VehicleTracker constructor:', error);
        }
    }
    
    initMap() {
        // Ensure map container exists and has dimensions
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.error('Map container not found');
            return;
        }
        
        // Force container dimensions if needed
        if (mapContainer.offsetHeight === 0) {
            mapContainer.style.height = '70vh';
            mapContainer.style.minHeight = '400px';
            mapContainer.style.width = '100%';
        }
        
        // Initialize map centered on India
        this.map = L.map('map', {
            preferCanvas: true,
            renderer: L.canvas()
        }).setView([20.5937, 78.9629], 5);
        
        // Add tile layer with error handling
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
            subdomains: ['a', 'b', 'c']
        });
        
        tileLayer.on('tileerror', function(error) {
            console.warn('Tile loading error:', error);
        });
        
        tileLayer.on('tileload', function() {
            console.log('Tiles loading successfully');
        });
        
        tileLayer.addTo(this.map);
        
        // Add scale control
        L.control.scale().addTo(this.map);
        
        // Force map resize after a short delay to ensure proper rendering
        setTimeout(() => {
            if (this.map) {
                this.map.invalidateSize();
                console.log('Map invalidateSize called');
            }
        }, 100);
        
        // Also invalidate size on window resize
        window.addEventListener('resize', () => {
            if (this.map) {
                this.map.invalidateSize();
            }
        });
        
        console.log('Map initialized successfully');
    }
    
    setupEventListeners() {
        // Filter controls
        document.getElementById('branchFilter').addEventListener('change', () => this.loadVehicleData());
        document.getElementById('vehicleFilter').addEventListener('change', () => this.loadVehicleData());
        document.getElementById('timeRange').addEventListener('change', () => this.loadVehicleData());
        
        // View toggle buttons
        document.querySelectorAll('.btn-toggle').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentView = e.target.dataset.view;
                this.updateMapView();
            });
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.showLoading(true);
            this.loadVehicleData();
        });
        
        // Heatmap toggle
        document.getElementById('toggleHeatmap').addEventListener('click', () => {
            if (this.heatmapLayer) {
                this.map.removeLayer(this.heatmapLayer);
                this.heatmapLayer = null;
            } else {
                this.loadHeatmapData();
            }
        });
    }
    
    async loadVehicleData() {
        try {
            const params = new URLSearchParams();
            
            // Get filter values
            const branchId = document.getElementById('branchFilter').value;
            const vehicleIds = Array.from(document.getElementById('vehicleFilter').selectedOptions)
                .map(option => option.value);
            const hoursBack = document.getElementById('timeRange').value;
            
            if (branchId) params.append('branch_id', branchId);
            if (vehicleIds.length > 0) {
                vehicleIds.forEach(id => params.append('vehicle_ids', id));
            }
            params.append('hours_back', hoursBack);
            
            const response = await fetch(`/tracking/api/vehicle-locations?${params}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            this.updateVehicleMarkers(data.locations);
            this.updateStats(data);
            this.updateLastUpdateTime();
            
        } catch (error) {
            console.error('Error loading vehicle data:', error);
            this.showError('Failed to load vehicle data: ' + error.message);
        } finally {
            this.showLoading(false);
        }
    }
    
    updateVehicleMarkers(locations) {
        // Clear existing markers
        Object.values(this.markers).forEach(marker => this.map.removeLayer(marker));
        this.markers = {};
        
        // Add new markers
        locations.forEach(vehicle => {
            const marker = this.createVehicleMarker(vehicle);
            this.markers[vehicle.vehicle_id] = marker;
            marker.addTo(this.map);
        });
        
        // Auto-fit map to show all vehicles if any exist
        if (locations.length > 0) {
            const group = new L.featureGroup(Object.values(this.markers));
            this.map.fitBounds(group.getBounds().pad(0.1));
        }
        
        this.updateVehicleList(locations);
    }
    
    createVehicleMarker(vehicle) {
        // Determine vehicle status and color
        let statusClass = 'vehicle-offline';
        let status = 'Offline';
        
        const recordedAt = new Date(vehicle.recorded_at);
        const now = new Date();
        const minutesAgo = (now - recordedAt) / (1000 * 60);
        
        if (minutesAgo < 10) {
            statusClass = 'vehicle-active';
            status = 'Active';
        } else if (minutesAgo < 60) {
            statusClass = 'vehicle-idle';
            status = 'Idle';
        }
        
        // Create custom icon
        const iconHtml = `<div class="vehicle-marker ${statusClass}"></div>`;
        const customIcon = L.divIcon({
            html: iconHtml,
            className: 'custom-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        // Create marker
        const marker = L.marker([vehicle.latitude, vehicle.longitude], {
            icon: customIcon
        });
        
        // Create popup content
        const popupContent = `
            <div class="p-2">
                <h6 class="mb-2">
                    <i class="fas fa-truck"></i> ${vehicle.vehicle_number}
                </h6>
                <p class="mb-1"><strong>Status:</strong> <span class="badge bg-${statusClass === 'vehicle-active' ? 'success' : statusClass === 'vehicle-idle' ? 'warning' : 'danger'}">${status}</span></p>
                <p class="mb-1"><strong>Driver:</strong> ${vehicle.driver_name}</p>
                <p class="mb-1"><strong>Type:</strong> ${vehicle.vehicle_type}</p>
                <p class="mb-1"><strong>Location:</strong> ${vehicle.location_name || 'Unknown'}</p>
                <p class="mb-1"><strong>Last Update:</strong> ${moment(vehicle.recorded_at).fromNow()}</p>
                <p class="mb-1"><strong>Odometer:</strong> ${vehicle.odometer_reading} km</p>
                <button class="btn btn-sm btn-primary mt-2" onclick="vehicleTracker.showVehicleDetails(${vehicle.vehicle_id})">
                    View Details
                </button>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        
        return marker;
    }
    
    updateVehicleList(locations) {
        const vehicleList = document.getElementById('vehicleList');
        
        if (locations.length === 0) {
            vehicleList.innerHTML = '<p class="text-muted">No vehicles found</p>';
            return;
        }
        
        let html = '';
        locations.forEach(vehicle => {
            const recordedAt = new Date(vehicle.recorded_at);
            const now = new Date();
            const minutesAgo = (now - recordedAt) / (1000 * 60);
            
            let statusClass = 'danger';
            let status = 'Offline';
            
            if (minutesAgo < 10) {
                statusClass = 'success';
                status = 'Active';
            } else if (minutesAgo < 60) {
                statusClass = 'warning';
                status = 'Idle';
            }
            
            html += `
                <div class="border rounded p-2 mb-2 cursor-pointer" onclick="vehicleTracker.focusVehicle(${vehicle.vehicle_id})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${vehicle.vehicle_number}</strong>
                            <br>
                            <small class="text-muted">${vehicle.driver_name}</small>
                        </div>
                        <span class="badge bg-${statusClass}">${status}</span>
                    </div>
                    <small class="text-muted">
                        ${moment(vehicle.recorded_at).fromNow()}
                    </small>
                </div>
            `;
        });
        
        vehicleList.innerHTML = html;
    }
    
    async loadHeatmapData() {
        try {
            const params = new URLSearchParams();
            
            // Get filter values
            const branchId = document.getElementById('branchFilter').value;
            const vehicleIds = Array.from(document.getElementById('vehicleFilter').selectedOptions)
                .map(option => option.value);
            const daysBack = Math.ceil(parseInt(document.getElementById('timeRange').value) / 24);
            
            if (branchId) params.append('branch_id', branchId);
            if (vehicleIds.length > 0) {
                vehicleIds.forEach(id => params.append('vehicle_ids', id));
            }
            params.append('days_back', daysBack);
            
            const response = await fetch(`/tracking/api/heatmap-data?${params}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Enhanced heatmap configuration
            const heatmapOptions = {
                radius: this.getAdaptiveRadius(),
                blur: 25,
                maxZoom: 18,
                minOpacity: 0.1,
                gradient: {
                    0.0: '#313695',
                    0.1: '#4575b4', 
                    0.3: '#74add1',
                    0.5: '#abd9e9',
                    0.7: '#fee090',
                    0.9: '#f46d43',
                    1.0: '#a50026'
                }
            };
            
            // Remove existing heatmap
            if (this.heatmapLayer) {
                this.map.removeLayer(this.heatmapLayer);
            }
            
            // Create enhanced heatmap layer
            this.heatmapLayer = L.heatLayer(data.heatmap_data, heatmapOptions).addTo(this.map);
            
            // Add heatmap controls
            this.addHeatmapControls();
            
            this.showNotification(`Heatmap loaded with ${data.total_points} data points`, 'success');
            
        } catch (error) {
            console.error('Error loading heatmap data:', error);
            this.showError('Failed to load heatmap data: ' + error.message);
        }
    }
    
    getAdaptiveRadius() {
        // Adaptive radius based on zoom level
        const zoom = this.map.getZoom();
        if (zoom >= 15) return 15;
        if (zoom >= 12) return 20;
        if (zoom >= 10) return 25;
        return 30;
    }
    
    addHeatmapControls() {
        if (this.heatmapControlsAdded) return;
        
        // Add heatmap intensity control
        const heatmapControl = L.control({ position: 'topright' });
        heatmapControl.onAdd = (map) => {
            const div = L.DomUtil.create('div', 'heatmap-controls');
            div.innerHTML = `
                <div class="bg-white p-2 rounded shadow">
                    <h6 class="mb-2">Heatmap Controls</h6>
                    <div class="mb-2">
                        <label class="form-label small">Intensity:</label>
                        <input type="range" class="form-range" id="heatmapIntensity" min="0.1" max="2" step="0.1" value="1">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Radius:</label>
                        <input type="range" class="form-range" id="heatmapRadius" min="10" max="50" step="5" value="20">
                    </div>
                    <button class="btn btn-sm btn-outline-danger" id="clearHeatmap">Clear</button>
                </div>
            `;
            
            // Prevent map events from bubbling
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);
            
            return div;
        };
        
        heatmapControl.addTo(this.map);
        this.heatmapControlsAdded = true;
        
        // Add event listeners
        setTimeout(() => {
            const intensitySlider = document.getElementById('heatmapIntensity');
            const radiusSlider = document.getElementById('heatmapRadius');
            const clearBtn = document.getElementById('clearHeatmap');
            
            if (intensitySlider) {
                intensitySlider.addEventListener('input', (e) => {
                    this.updateHeatmapIntensity(parseFloat(e.target.value));
                });
            }
            
            if (radiusSlider) {
                radiusSlider.addEventListener('input', (e) => {
                    this.updateHeatmapRadius(parseInt(e.target.value));
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    this.clearHeatmap();
                });
            }
        }, 100);
    }
    
    updateHeatmapIntensity(intensity) {
        if (this.heatmapLayer) {
            this.heatmapLayer.setOptions({ minOpacity: intensity * 0.1 });
        }
    }
    
    updateHeatmapRadius(radius) {
        if (this.heatmapLayer) {
            this.heatmapLayer.setOptions({ radius: radius });
        }
    }
    
    clearHeatmap() {
        if (this.heatmapLayer) {
            this.map.removeLayer(this.heatmapLayer);
            this.heatmapLayer = null;
            this.showNotification('Heatmap cleared', 'info');
        }
    }
    
    updateMapView() {
        // Hide/show layers based on current view
        if (this.currentView === 'live') {
            Object.values(this.markers).forEach(marker => this.map.addLayer(marker));
            if (this.heatmapLayer) this.map.removeLayer(this.heatmapLayer);
            Object.values(this.pathLayers).forEach(layer => this.map.removeLayer(layer));
        } else if (this.currentView === 'heatmap') {
            Object.values(this.markers).forEach(marker => this.map.removeLayer(marker));
            Object.values(this.pathLayers).forEach(layer => this.map.removeLayer(layer));
            if (!this.heatmapLayer) this.loadHeatmapData();
        } else if (this.currentView === 'paths') {
            if (this.heatmapLayer) this.map.removeLayer(this.heatmapLayer);
            // Load paths for visible vehicles
            this.loadVehiclePaths();
        }
    }
    
    async loadVehiclePaths() {
        // Implementation for loading vehicle paths
        console.log('Loading vehicle paths...');
    }
    
    focusVehicle(vehicleId) {
        const marker = this.markers[vehicleId];
        if (marker) {
            this.map.setView(marker.getLatLng(), 15);
            marker.openPopup();
        }
    }
    
    showVehicleDetails(vehicleId) {
        // Implementation for showing vehicle details modal
        console.log('Showing vehicle details for:', vehicleId);
    }
    
    updateStats(data) {
        document.getElementById('totalVehicles').textContent = data.total_vehicles;
    }
    
    updateLastUpdateTime() {
        document.getElementById('lastUpdate').textContent = moment().format('HH:mm:ss');
    }
    
    showLoading(show) {
        const refreshBtn = document.getElementById('refreshBtn');
        const icon = refreshBtn.querySelector('i');
        
        if (show) {
            icon.classList.add('refresh-btn');
        } else {
            icon.classList.remove('refresh-btn');
        }
    }
    
    showError(message) {
        // Simple error display - in production, use a proper notification system
        alert('Error: ' + message);
    }
    
    initSocket() {
        // Initialize Socket.IO connection for real-time updates with timeout and error handling
        console.log('Initializing Socket.IO connection...');
        
        this.socket = io({
            timeout: 10000,  // 10 second timeout
            transports: ['websocket', 'polling'],  // Allow fallback to polling
            upgrade: true,
            rememberUpgrade: true
        });
        
        this.socket.on('connect', () => {
            console.log('Connected to real-time vehicle tracking');
            this.updateConnectionStatus('connected');
            this.socket.emit('join_tracking', {});
        });
        
        this.socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            this.updateConnectionStatus('error');
            // Retry connection after 5 seconds
            setTimeout(() => {
                console.log('Retrying Socket.IO connection...');
                this.socket.connect();
            }, 5000);
        });
        
        this.socket.on('disconnect', (reason) => {
            console.log('Disconnected from real-time tracking:', reason);
            this.updateConnectionStatus('disconnected');
            
            // Auto-reconnect if not intentional
            if (reason === 'io server disconnect') {
                this.socket.connect();
            }
        });
        
        this.socket.on('reconnect', (attemptNumber) => {
            console.log('Reconnected to real-time tracking after', attemptNumber, 'attempts');
            this.updateConnectionStatus('connected');
        });
        
        this.socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('Reconnection attempt:', attemptNumber);
            this.updateConnectionStatus('reconnecting');
        });
        
        this.socket.on('vehicle_location_update', (data) => {
            console.log('Real-time vehicle update received:', data);
            this.handleRealTimeUpdate(data);
        });
        
        this.socket.on('vehicle_status_change', (data) => {
            console.log('Vehicle status change:', data);
            this.handleStatusChange(data);
        });
        
        // Set connecting timeout
        setTimeout(() => {
            if (!this.socket.connected) {
                console.warn('Socket.IO connection taking too long, checking status...');
                this.updateConnectionStatus('timeout');
            }
        }, 15000);  // 15 seconds timeout
        
        // Initialize mobile features
        this.initMobileFeatures();
    }
    
    updateConnectionStatus(status) {
        const statusElement = document.getElementById('connectionStatus');
        if (statusElement) {
            switch(status) {
                case 'connected':
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Connected';
                    break;
                case 'disconnected':
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = 'Disconnected';
                    break;
                case 'error':
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = 'Connection Error';
                    break;
                case 'timeout':
                    statusElement.className = 'badge bg-warning';
                    statusElement.textContent = 'Connection Timeout';
                    break;
                case 'reconnecting':
                    statusElement.className = 'badge bg-warning';
                    statusElement.textContent = 'Reconnecting...';
                    break;
                default:
                    statusElement.className = 'badge bg-secondary';
                    statusElement.textContent = 'Connecting...';
            }
        }
    }
    
    initMobileFeatures() {
        // Show mobile location panel if on mobile device
        if (this.isMobileDevice()) {
            const mobilePanel = document.getElementById('mobileLocationPanel');
            if (mobilePanel) {
                mobilePanel.style.display = 'block';
            }
        }
        
        // Set up location sharing
        const shareBtn = document.getElementById('shareLocationBtn');
        if (shareBtn) {
            shareBtn.addEventListener('click', () => {
                this.toggleLocationSharing();
            });
        }
    }
    
    isMobileDevice() {
        return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    async toggleLocationSharing() {
        const shareBtn = document.getElementById('shareLocationBtn');
        const statusDiv = document.getElementById('locationStatus');
        
        if (this.locationWatchId) {
            // Stop sharing location
            navigator.geolocation.clearWatch(this.locationWatchId);
            this.locationWatchId = null;
            
            shareBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Start Sharing Location';
            shareBtn.className = 'btn btn-success btn-sm w-100 mb-2';
            statusDiv.textContent = 'Location sharing disabled';
            statusDiv.className = 'small text-muted';
            
            this.showNotification('Location sharing stopped', 'info');
        } else {
            // Start sharing location
            if (!navigator.geolocation) {
                this.showNotification('Geolocation is not supported by this browser', 'warning');
                return;
            }
            
            try {
                // Get permission and start watching
                const position = await this.getCurrentPosition();
                
                shareBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Sharing Location';
                shareBtn.className = 'btn btn-danger btn-sm w-100 mb-2';
                statusDiv.textContent = 'Location sharing active';
                statusDiv.className = 'small text-success';
                
                // Start continuous location watching
                this.locationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        this.sendLocationUpdate(position);
                    },
                    (error) => {
                        console.error('Location error:', error);
                        this.showNotification('Location access error: ' + error.message, 'warning');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    }
                );
                
                this.showNotification('Location sharing started', 'success');
                
            } catch (error) {
                this.showNotification('Failed to access location: ' + error.message, 'warning');
            }
        }
    }
    
    getCurrentPosition() {
        return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        });
    }
    
    sendLocationUpdate(position) {
        const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: new Date().toISOString(),
            speed: position.coords.speed || 0,
            heading: position.coords.heading || 0
        };
        
        // Send via WebSocket
        if (this.socket && this.socket.connected) {
            this.socket.emit('location_update', locationData);
        }
        
        // Also send via API as backup
        this.sendLocationToAPI(locationData);
        
        // Update status
        const statusDiv = document.getElementById('locationStatus');
        if (statusDiv) {
            statusDiv.innerHTML = `
                <i class="fas fa-location-dot text-success"></i> 
                Location updated (±${Math.round(position.coords.accuracy)}m)
                <br><small class="text-muted">${new Date().toLocaleTimeString()}</small>
            `;
        }
    }
    
    async sendLocationToAPI(locationData) {
        try {
            // Send to driver location update REST API fallback
            const response = await fetch('/tracking/api/driver-location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(locationData)
            });
            
            if (!response.ok) {
                console.warn('Failed to send location to API');
            } else {
                console.log('Location successfully sent via REST API fallback');
            }
        } catch (error) {
            console.warn('API location update failed:', error);
        }
    }
    
    handleRealTimeUpdate(data) {
        // Update vehicle marker with new location data
        if (data.vehicle_id && this.markers[data.vehicle_id]) {
            const marker = this.markers[data.vehicle_id];
            const newLatLng = L.latLng(data.latitude, data.longitude);
            
            // Animate marker to new position
            marker.setLatLng(newLatLng);
            
            // Update popup content with new data
            this.updateMarkerPopup(marker, data);
            
            // Show notification for significant moves
            if (data.is_significant_move) {
                this.showNotification(`Vehicle ${data.vehicle_number} moved to ${data.location_name}`, 'info');
            }
        } else {
            // New vehicle appeared, reload all data
            this.loadVehicleData();
        }
    }
    
    handleStatusChange(data) {
        // Handle vehicle status changes (active/idle/offline)
        if (data.vehicle_id && this.markers[data.vehicle_id]) {
            const marker = this.markers[data.vehicle_id];
            this.updateMarkerStyle(marker, data.status);
            this.showNotification(`Vehicle ${data.vehicle_number} is now ${data.status}`, 'warning');
        }
    }
    
    updateMarkerPopup(marker, data) {
        const popupContent = `
            <div class="p-2">
                <h6 class="mb-2">
                    <i class="fas fa-truck"></i> ${data.vehicle_number}
                </h6>
                <p class="mb-1"><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                <p class="mb-1"><strong>Driver:</strong> ${data.driver_name}</p>
                <p class="mb-1"><strong>Location:</strong> ${data.location_name || 'Unknown'}</p>
                <p class="mb-1"><strong>Last Update:</strong> Just now</p>
                <p class="mb-1"><strong>Speed:</strong> ${data.speed || 0} km/h</p>
                <button class="btn btn-sm btn-primary mt-2" onclick="vehicleTracker.showVehicleDetails(${data.vehicle_id})">
                    View Details
                </button>
            </div>
        `;
        marker.setPopupContent(popupContent);
    }
    
    showNotification(message, type = 'info') {
        // Create toast notification
        const toastContainer = document.getElementById('toast-container') || this.createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'info' ? 'primary' : type === 'warning' ? 'warning' : 'success'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        toastContainer.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
        bsToast.show();
        
        // Remove after animation
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
        return container;
    }
    
    startAutoRefresh() {
        // Reduced polling frequency since we have real-time updates
        this.refreshInterval = setInterval(() => {
            this.loadVehicleData();
        }, 120000); // Every 2 minutes as fallback
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
        
        if (this.socket) {
            this.socket.disconnect();
        }
    }
}

// Initialize when page loads
let vehicleTracker;
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - starting VehicleTracker initialization');
    
    // Check if Leaflet is available
    if (typeof L === 'undefined') {
        console.error('Leaflet library not loaded!');
        return;
    }
    console.log('Leaflet library is available');
    
    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('Map container not found!');
        return;
    }
    console.log('Map container found:', mapContainer);
    
    // Initialize VehicleTracker
    try {
        vehicleTracker = new VehicleTracker();
        window.map = vehicleTracker.map; // Make map globally accessible for debugging
        console.log('VehicleTracker initialized successfully');
    } catch (error) {
        console.error('Failed to initialize VehicleTracker:', error);
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (vehicleTracker) {
        vehicleTracker.stopAutoRefresh();
    }
});
</script>
{% endblock %}