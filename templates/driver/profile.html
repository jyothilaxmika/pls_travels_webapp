{% extends "base.html" %}

{% block title %}Driver Profile - PLS TRAVELS{% endblock %}

{% block content %}
<!-- Include Camera Capture Component -->
{% include 'components/camera_capture.html' %}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-user me-2"></i>My Profile</h3>
        {% if driver and driver.status %}
        <span class="badge bg-{{ 'success' if driver.status.value == 'active' else 'warning' if driver.status.value == 'pending' else 'secondary' }} fs-6">
            {{ driver.status.value.title() }}
        </span>
        {% endif %}
    </div>
    
    <!-- Profile Form -->
    <form method="POST" enctype="multipart/form-data">
        <!-- Personal Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-user-circle me-2"></i>Personal Information</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="full_name" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" name="full_name" id="full_name" 
                               value="{{ driver.full_name if driver else '' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone" class="form-label">Primary Phone *</label>
                        <input type="tel" class="form-control" name="phone" id="phone" 
                               value="{{ driver.user.phone if driver and driver.user else '' }}" required>
                    </div>
                </div>
                
                <!-- Additional Phone Numbers -->
                <div class="row">
                    <div class="col-md-12 mb-2">
                        <h6 class="text-muted">Additional Contact Numbers <small>(Optional)</small></h6>
                    </div>
                    {% set additional_phones = driver.get_additional_phones() if driver else [] %}
                    <div class="col-md-4 mb-3">
                        <label for="additional_phone_1" class="form-label">Additional Phone 1</label>
                        <input type="tel" class="form-control" name="additional_phone_1" id="additional_phone_1" 
                               value="{{ additional_phones[0] if additional_phones|length > 0 else '' }}" 
                               placeholder="Enter additional mobile number">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="additional_phone_2" class="form-label">Additional Phone 2</label>
                        <input type="tel" class="form-control" name="additional_phone_2" id="additional_phone_2" 
                               value="{{ additional_phones[1] if additional_phones|length > 1 else '' }}" 
                               placeholder="Enter additional mobile number">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="additional_phone_3" class="form-label">Additional Phone 3</label>
                        <input type="tel" class="form-control" name="additional_phone_3" id="additional_phone_3" 
                               value="{{ additional_phones[2] if additional_phones|length > 2 else '' }}" 
                               placeholder="Enter additional mobile number">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" name="address" id="address" rows="3">{{ driver.current_address if driver else '' }}</textarea>
                </div>
                
                {% if not driver %}
                <div class="mb-3">
                    <label for="branch_id" class="form-label">Branch *</label>
                    <select class="form-select" name="branch_id" id="branch_id" required>
                        <option value="">Select Branch</option>
                        {% for branch in branches %}
                        <option value="{{ branch.id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% else %}
                <div class="mb-3">
                    <label class="form-label">Branch</label>
                    <input type="text" class="form-control" value="{{ driver.branch.name }}" readonly>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Documents -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-id-card me-2"></i>Documents</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="aadhar_number" class="form-label">Aadhar Number *</label>
                        <input type="text" class="form-control" name="aadhar_number" id="aadhar_number" 
                               value="{{ driver.aadhar_number if driver else '' }}" 
                               maxlength="12" pattern="[0-9]{12}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="license_number" class="form-label">License Number *</label>
                        <input type="text" class="form-control" name="license_number" id="license_number" 
                               value="{{ driver.license_number if driver else '' }}" required>
                    </div>
                </div>
                
                <!-- Document Capture Section -->
                {% if not driver or driver.status in ['pending', 'rejected'] %}
                <div class="row">
                    <!-- Aadhar Photo Upload -->
                    <div class="col-md-4 mb-3" id="aadhar_photo_container">
                        <label class="form-label">Aadhar Photo *</label>
                        
                        <!-- Camera Capture Option -->
                        <div class="camera-capture-container mb-2">
                            <button type="button" class="btn btn-primary capture-photo-btn w-100" 
                                    onclick="initCameraCapture('aadhar_photo', 'Capture Aadhar Photo')">
                                <i class="fas fa-camera me-2"></i>Capture Aadhar Photo
                            </button>
                        </div>
                        
                        <!-- OR separator -->
                        <div class="text-center mb-2">
                            <small class="text-muted">OR</small>
                        </div>
                        
                        <!-- File Upload Option -->
                        <div class="file-upload-container">
                            <input type="file" class="form-control" id="aadhar_photo" name="aadhar_photo" accept="image/*,.pdf" 
                                   onchange="previewFile(this, 'aadhar_preview')">
                            <small class="d-block text-muted mt-1">Upload Aadhar card (JPG, PNG, PDF)</small>
                        </div>
                        
                        <!-- Photo Preview -->
                        <div class="photo-preview mt-3" style="display: none;">
                            <img class="img-fluid rounded" style="max-height: 150px; width: 100%;" alt="Captured Aadhar Photo">
                            <small class="d-block text-success mt-1">Photo captured with location & timestamp</small>
                        </div>
                        
                        <!-- File Preview -->
                        <div class="file-preview mt-2" id="aadhar_preview" style="display: none;">
                            <img class="img-fluid rounded" style="max-height: 100px;" alt="Aadhar Preview">
                            <small class="d-block text-success mt-1">File selected for upload</small>
                        </div>
                        
                        {% if driver and driver.aadhar_document %}
                        <div class="mt-2">
                            <p class="mb-1"><strong>Current Document:</strong></p>
                            {% if driver.aadhar_document.startswith('gs://') %}
                                <small class="d-block text-info">Stored in cloud storage</small>
                                <i class="fas fa-cloud text-primary"></i> Cloud stored document
                            {% else %}
                                <img src="/uploads/{{ driver.aadhar_document }}" class="img-fluid rounded" style="max-height: 100px;" onerror="this.style.display='none';">
                                <small class="d-block text-info">Previously uploaded</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- License Photo Upload -->
                    <div class="col-md-4 mb-3" id="license_photo_container">
                        <label class="form-label">License Photo *</label>
                        
                        <!-- Camera Capture Option -->
                        <div class="camera-capture-container mb-2">
                            <button type="button" class="btn btn-primary capture-photo-btn w-100" 
                                    onclick="initCameraCapture('license_photo', 'Capture License Photo')">
                                <i class="fas fa-camera me-2"></i>Capture License Photo
                            </button>
                        </div>
                        
                        <!-- OR separator -->
                        <div class="text-center mb-2">
                            <small class="text-muted">OR</small>
                        </div>
                        
                        <!-- File Upload Option -->
                        <div class="file-upload-container">
                            <input type="file" class="form-control" id="license_photo" name="license_photo" accept="image/*,.pdf" 
                                   onchange="previewFile(this, 'license_preview')">
                            <small class="d-block text-muted mt-1">Upload driving license (JPG, PNG, PDF)</small>
                        </div>
                        
                        <!-- Photo Preview -->
                        <div class="photo-preview mt-3" style="display: none;">
                            <img class="img-fluid rounded" style="max-height: 150px; width: 100%;" alt="Captured License Photo">
                            <small class="d-block text-success mt-1">Photo captured with location & timestamp</small>
                        </div>
                        
                        <!-- File Preview -->
                        <div class="file-preview mt-2" id="license_preview" style="display: none;">
                            <img class="img-fluid rounded" style="max-height: 100px;" alt="License Preview">
                            <small class="d-block text-success mt-1">File selected for upload</small>
                        </div>
                        
                        {% if driver and driver.license_document %}
                        <div class="mt-2">
                            <p class="mb-1"><strong>Current Document:</strong></p>
                            {% if driver.license_document.startswith('gs://') %}
                                <small class="d-block text-info">Stored in cloud storage</small>
                                <i class="fas fa-cloud text-primary"></i> Cloud stored document
                            {% else %}
                                <img src="/uploads/{{ driver.license_document }}" class="img-fluid rounded" style="max-height: 100px;" onerror="this.style.display='none';">
                                <small class="d-block text-info">Previously uploaded</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Profile Photo Upload -->
                    <div class="col-md-4 mb-3" id="profile_photo_container">
                        <label class="form-label">Profile Photo *</label>
                        
                        <!-- Camera Capture Option -->
                        <div class="camera-capture-container mb-2">
                            <button type="button" class="btn btn-primary capture-photo-btn w-100" 
                                    onclick="initCameraCapture('profile_photo', 'Capture Profile Photo')">
                                <i class="fas fa-camera me-2"></i>Capture Profile Photo
                            </button>
                        </div>
                        
                        <!-- OR separator -->
                        <div class="text-center mb-2">
                            <small class="text-muted">OR</small>
                        </div>
                        
                        <!-- File Upload Option -->
                        <div class="file-upload-container">
                            <input type="file" class="form-control" id="profile_photo" name="profile_photo" accept="image/*" 
                                   onchange="previewFile(this, 'profile_preview')">
                            <small class="d-block text-muted mt-1">Upload your profile photo (JPG, PNG)</small>
                        </div>
                        
                        <!-- Photo Preview -->
                        <div class="photo-preview mt-3" style="display: none;">
                            <img class="img-fluid rounded" style="max-height: 150px; width: 100%;" alt="Captured Profile Photo">
                            <small class="d-block text-success mt-1">Photo captured with location & timestamp</small>
                        </div>
                        
                        <!-- File Preview -->
                        <div class="file-preview mt-2" id="profile_preview" style="display: none;">
                            <img class="img-fluid rounded" style="max-height: 100px;" alt="Profile Preview">
                            <small class="d-block text-success mt-1">File selected for upload</small>
                        </div>
                        
                        {% if driver and driver.profile_photo %}
                        <div class="mt-2">
                            <p class="mb-1"><strong>Current Photo:</strong></p>
                            {% if driver.profile_photo.startswith('gs://') %}
                                <small class="d-block text-info">Stored in cloud storage</small>
                                <i class="fas fa-cloud text-primary"></i> Cloud stored photo
                            {% else %}
                                <img src="/uploads/{{ driver.profile_photo }}" class="img-fluid rounded" style="max-height: 100px;">
                                <small class="d-block text-info">Previously uploaded</small>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <!-- Show existing documents for approved drivers -->
                <div class="row">
                    {% if driver.aadhar_photo %}
                    <div class="col-md-4 text-center mb-3">
                        <p><strong>Aadhar Photo</strong></p>
                        <img src="/uploads/{{ driver.aadhar_photo }}" class="img-fluid rounded" style="max-height: 150px;">
                    </div>
                    {% endif %}
                    {% if driver.license_photo %}
                    <div class="col-md-4 text-center mb-3">
                        <p><strong>License Photo</strong></p>
                        <img src="/uploads/{{ driver.license_photo }}" class="img-fluid rounded" style="max-height: 150px;">
                    </div>
                    {% endif %}
                    {% if driver.profile_photo %}
                    <div class="col-md-4 text-center mb-3">
                        <p><strong>Profile Photo</strong></p>
                        <img src="/uploads/{{ driver.profile_photo }}" class="img-fluid rounded" style="max-height: 150px;">
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Bank Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-university me-2"></i>Bank Details</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="bank_name" class="form-label">Bank Name</label>
                        <input type="text" class="form-control" name="bank_name" id="bank_name" 
                               value="{{ driver.bank_name if driver else '' }}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="account_number" class="form-label">Account Number</label>
                        <input type="text" class="form-control" name="account_number" id="account_number" 
                               value="{{ driver.account_number if driver else '' }}">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="ifsc_code" class="form-label">IFSC Code</label>
                        <input type="text" class="form-control" name="ifsc_code" id="ifsc_code" 
                               value="{{ driver.ifsc_code if driver else '' }}" style="text-transform: uppercase;">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="account_holder_name" class="form-label">Account Holder Name</label>
                        <input type="text" class="form-control" name="account_holder_name" id="account_holder_name" 
                               value="{{ driver.account_holder_name if driver else '' }}">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Status Information -->
        {% if driver %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Profile Status</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Status:</strong> 
                            {% if driver.status.value == 'active' %}
                                <span class="badge bg-success">Active</span>
                            {% elif driver.status.value == 'pending' %}
                                <span class="badge bg-warning">Pending Approval</span>
                            {% elif driver.status.value == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ driver.status.value.title() }}</span>
                            {% endif %}
                        </p>
                        <p><strong>Profile Created:</strong> {{ driver.created_at.strftime('%Y-%m-%d') }}</p>
                        {% if driver.approved_at %}
                        <p><strong>Approved On:</strong> {{ driver.approved_at.strftime('%Y-%m-%d') }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if driver.status.value == 'active' %}
                        <p><strong>Total Earnings:</strong> ₹{{ "{:,.2f}".format(driver.total_earnings) }}</p>
                        {% if driver.current_vehicle %}
                        <p><strong>Current Vehicle:</strong> {{ driver.current_vehicle.registration_number }}</p>
                        {% endif %}
                        {% endif %}
                        
                        {% if driver.approver %}
                        <p><strong>Approved By:</strong> {{ driver.approver.username }}</p>
                        {% endif %}
                    </div>
                </div>
                
                {% if driver.status.value == 'pending' %}
                <div class="alert alert-info">
                    <i class="fas fa-clock me-2"></i>
                    Your profile is under review. You will be notified once approved.
                </div>
                {% elif driver.status.value == 'rejected' %}
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Your profile was rejected. Please update the required information and resubmit.
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Submit Button -->
        <div class="row">
            <div class="col-12 mb-4">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-save me-2"></i>
                    {{ 'Update Profile' if driver else 'Create Profile' }}
                </button>
                
                {% if driver %}
                <div class="text-center mt-3">
                    <a href="{{ url_for('driver.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </form>

    <!-- Enhanced Document Showcase -->
    {% if driver and (driver.aadhar_document or driver.license_document or driver.profile_photo) %}
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-id-card-alt me-2"></i>Document Showcase</h6>
                <span class="badge bg-light text-primary">
                    {{ [driver.aadhar_document, driver.license_document, driver.profile_photo] | select | list | length }} Documents
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Aadhar Document Card -->
                {% if driver.aadhar_document %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 border-success document-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-success"><i class="fas fa-id-card me-2"></i>Aadhar Card</h6>
                                <span class="badge bg-{{ 'success' if driver.aadhar_verified else 'warning' }}">
                                    {{ 'Verified' if driver.aadhar_verified else 'Pending' }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <div class="document-preview position-relative">
                                <img src="/uploads/{{ driver.aadhar_document }}" 
                                     class="img-fluid rounded document-thumbnail cursor-pointer" 
                                     style="width: 100%; height: 180px; object-fit: cover;"
                                     alt="Aadhar Document"
                                     onclick="showDocumentModal('{{ driver.aadhar_document }}', 'Aadhar Card', 'aadhar')">
                                <div class="document-overlay">
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="showDocumentModal('{{ driver.aadhar_document }}', 'Aadhar Card', 'aadhar')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <a href="/uploads/{{ driver.aadhar_document }}" 
                                       class="btn btn-success btn-sm ms-1" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <div><strong>Number:</strong> {{ driver.aadhar_number or 'Not provided' }}</div>
                                {% if driver.aadhar_verified_at %}
                                <div><strong>Verified:</strong> {{ driver.aadhar_verified_at.strftime('%d/%m/%Y') }}</div>
                                {% endif %}
                                <div><strong>Status:</strong> 
                                    <span class="text-{{ 'success' if driver.aadhar_verified else 'warning' }}">
                                        {{ 'Verified' if driver.aadhar_verified else 'Under Review' }}
                                    </span>
                                </div>
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- License Document Card -->
                {% if driver.license_document %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 border-info document-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-info"><i class="fas fa-car me-2"></i>Driving License</h6>
                                <span class="badge bg-{{ 'success' if driver.license_verified else 'warning' }}">
                                    {{ 'Verified' if driver.license_verified else 'Pending' }}
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <div class="document-preview position-relative">
                                <img src="/uploads/{{ driver.license_document }}" 
                                     class="img-fluid rounded document-thumbnail cursor-pointer" 
                                     style="width: 100%; height: 180px; object-fit: cover;"
                                     alt="License Document"
                                     onclick="showDocumentModal('{{ driver.license_document }}', 'Driving License', 'license')">
                                <div class="document-overlay">
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="showDocumentModal('{{ driver.license_document }}', 'Driving License', 'license')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <a href="/uploads/{{ driver.license_document }}" 
                                       class="btn btn-success btn-sm ms-1" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <div><strong>Number:</strong> {{ driver.license_number or 'Not provided' }}</div>
                                <div><strong>Type:</strong> {{ driver.license_type or 'LMV' }}</div>
                                {% if driver.license_expiry %}
                                <div><strong>Expires:</strong> 
                                    <span class="text-{{ 'danger' if driver.license_expiry < moment().date() else 'success' }}">
                                        {{ driver.license_expiry.strftime('%d/%m/%Y') }}
                                    </span>
                                </div>
                                {% endif %}
                                {% if driver.license_verified_at %}
                                <div><strong>Verified:</strong> {{ driver.license_verified_at.strftime('%d/%m/%Y') }}</div>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Profile Photo Card -->
                {% if driver.profile_photo %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100 border-secondary document-card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-secondary"><i class="fas fa-user-circle me-2"></i>Profile Photo</h6>
                                <span class="badge bg-success">Active</span>
                            </div>
                        </div>
                        <div class="card-body p-2">
                            <div class="document-preview position-relative">
                                <img src="/uploads/{{ driver.profile_photo }}" 
                                     class="img-fluid rounded document-thumbnail cursor-pointer" 
                                     style="width: 100%; height: 180px; object-fit: cover;"
                                     alt="Profile Photo"
                                     onclick="showDocumentModal('{{ driver.profile_photo }}', 'Profile Photo', 'profile')">
                                <div class="document-overlay">
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="showDocumentModal('{{ driver.profile_photo }}', 'Profile Photo', 'profile')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <a href="/uploads/{{ driver.profile_photo }}" 
                                       class="btn btn-success btn-sm ms-1" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <div><strong>Purpose:</strong> Profile & Authentication</div>
                                <div><strong>Format:</strong> High Resolution Image</div>
                                {% if driver.updated_at %}
                                <div><strong>Updated:</strong> {{ driver.updated_at.strftime('%d/%m/%Y') }}</div>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Document Status Summary -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Document Status</h6>
                        <div class="row">
                            {% if driver.aadhar_document %}
                            <div class="col-md-4">
                                <i class="fas fa-id-card text-success me-2"></i>
                                <strong>Aadhar:</strong> 
                                <span class="text-{{ 'success' if driver.aadhar_verified else 'warning' }}">
                                    {{ 'Verified ✓' if driver.aadhar_verified else 'Under Review ⏳' }}
                                </span>
                            </div>
                            {% endif %}
                            {% if driver.license_document %}
                            <div class="col-md-4">
                                <i class="fas fa-car text-info me-2"></i>
                                <strong>License:</strong> 
                                <span class="text-{{ 'success' if driver.license_verified else 'warning' }}">
                                    {{ 'Verified ✓' if driver.license_verified else 'Under Review ⏳' }}
                                </span>
                            </div>
                            {% endif %}
                            {% if driver.profile_photo %}
                            <div class="col-md-4">
                                <i class="fas fa-user-circle text-secondary me-2"></i>
                                <strong>Profile:</strong> <span class="text-success">Active ✓</span>
                            </div>
                            {% endif %}
                        </div>
                        <hr class="my-2">
                        <small class="text-muted">
                            Documents are reviewed by admin within 24-48 hours. Verified documents cannot be changed without admin approval.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Financial Summary Section -->
    {% if driver %}
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-wallet me-2"></i>Financial Summary</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4 class="mb-0">₹{{ "%.2f"|format(total_earnings) }}</h4>
                            <small>Total Earnings</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body text-center">
                            <h4 class="mb-0">₹{{ "%.2f"|format(total_advances) }}</h4>
                            <small>Total Advances</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h4 class="mb-0">₹{{ "%.2f"|format(total_deductions) }}</h4>
                            <small>Total Deductions</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4 class="mb-0">₹{{ "%.2f"|format(total_earnings - total_deductions) }}</h4>
                            <small>Net Earnings</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Financial Transactions -->
    {% if driver and recent_transactions %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Recent Financial Transactions</h6>
            <span class="badge bg-secondary">{{ recent_transactions|length }} transactions</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Vehicle</th>
                            <th>Advance</th>
                            <th>Fuel Deduction</th>
                            <th>Penalty</th>
                            <th>Total Deduction</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in recent_transactions %}
                        <tr>
                            <td>{{ transaction.start_time.strftime('%d/%m/%Y') if transaction.start_time else 'N/A' }}</td>
                            <td>{{ transaction.vehicle.registration_number if transaction.vehicle else 'N/A' }}</td>
                            <td class="text-warning">₹{{ "%.2f"|format(transaction.advance_deduction) }}</td>
                            <td class="text-danger">₹{{ "%.2f"|format(transaction.fuel_deduction) }}</td>
                            <td class="text-danger">₹{{ "%.2f"|format(transaction.penalty_deduction) }}</td>
                            <td class="text-danger fw-bold">₹{{ "%.2f"|format(transaction.advance_deduction + transaction.fuel_deduction + transaction.penalty_deduction) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Duties History -->
    {% if driver and all_duties %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-history me-2"></i>Duty History</h6>
            <span class="badge bg-primary">{{ all_duties|length }} duties</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Vehicle</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Distance</th>
                            <th>Trips</th>
                            <th>Revenue</th>
                            <th>Earnings</th>
                            <th>Duty Scheme</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for duty in all_duties %}
                        <tr>
                            <td>{{ duty.start_time.strftime('%d/%m/%Y') if duty.start_time else 'N/A' }}</td>
                            <td>{{ duty.vehicle.registration_number if duty.vehicle else 'N/A' }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if duty.status.value == 'completed' else 'warning' if duty.status.value == 'active' else 'secondary' }}">
                                    {{ duty.status.value.title() }}
                                </span>
                            </td>
                            <td>
                                {% if duty.start_time and duty.actual_end %}
                                    {% set duration = (duty.actual_end - duty.start_time).total_seconds() / 3600 %}
                                    {{ "%.1f"|format(duration) }}h
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ duty.total_distance if duty.total_distance else 0 }} km</td>
                            <td>{{ duty.total_trips if duty.total_trips else 0 }}</td>
                            <td class="text-success">₹{{ "%.2f"|format(duty.total_revenue) if duty.total_revenue else 0 }}</td>
                            <td class="text-primary fw-bold">₹{{ "%.2f"|format(duty.driver_earnings) if duty.driver_earnings else 0 }}</td>
                            <td>
                                {% if duty.duty_scheme %}
                                    <small class="text-muted">{{ duty.duty_scheme.name }}</small>
                                {% else %}
                                    <small class="text-muted">No scheme</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Help Section -->
    <div class="card border-info">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>Help & Guidelines</h6>
        </div>
        <div class="card-body">
            <ul class="mb-0">
                <li>Ensure all personal information is accurate and matches your documents</li>
                <li>Upload clear, readable photos of documents (JPEG/PNG format)</li>
                <li>Bank details are required for salary processing</li>
                <li>Profile approval may take 1-2 business days</li>
                <li>Contact your branch manager for any queries</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Auto-format IFSC code
document.getElementById('ifsc_code').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});

// Aadhar number formatting
document.getElementById('aadhar_number').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 12);
});

// File upload preview
function setupFilePreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    if (input) {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create or update preview
                    let preview = document.getElementById(previewId);
                    if (!preview) {
                        preview = document.createElement('img');
                        preview.id = previewId;
                        preview.className = 'img-fluid rounded mt-2';
                        preview.style.maxHeight = '100px';
                        input.parentNode.appendChild(preview);
                    }
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

// Setup previews for file inputs
setupFilePreview('aadhar_photo', 'aadhar_preview');
setupFilePreview('license_photo', 'license_preview');
setupFilePreview('profile_photo', 'profile_preview');

// Document showcase enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effects to document cards
    const documentCards = document.querySelectorAll('.document-card');
    documentCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

// Document viewer modal function
function showDocumentModal(documentPath, title, type) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('documentModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'documentModal';
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="documentModalTitle">Document Viewer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="documentModalImage" class="img-fluid rounded" style="max-height: 70vh;">
                    </div>
                    <div class="modal-footer">
                        <div class="d-flex justify-content-between w-100">
                            <div>
                                <span class="badge bg-primary" id="documentType"></span>
                            </div>
                            <div>
                                <a id="documentDownload" class="btn btn-success" download>
                                    <i class="fas fa-download me-2"></i>Download
                                </a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Update modal content
    document.getElementById('documentModalTitle').textContent = title;
    document.getElementById('documentModalImage').src = '/uploads/' + documentPath;
    document.getElementById('documentDownload').href = '/uploads/' + documentPath;
    document.getElementById('documentType').textContent = type.toUpperCase() + ' DOCUMENT';
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}
</script>

<style>
.document-card {
    transition: all 0.3s ease;
    border-radius: 10px;
}

.document-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.document-preview {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
}

.document-thumbnail {
    transition: transform 0.3s ease;
}

.document-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.document-preview:hover .document-overlay {
    opacity: 1;
}

.document-preview:hover .document-thumbnail {
    transform: scale(1.05);
}

.cursor-pointer {
    cursor: pointer;
}

.badge {
    font-size: 0.75rem;
}
</style>

{% endblock %}
