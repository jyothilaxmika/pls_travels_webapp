{% extends "base.html" %}

{% block title %}Duty Management - PLS TRAVELS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-play-circle me-2"></i>Duty Management</h3>
        <div class="text-muted">
            <small>{{ moment().format('MMM DD, YYYY') }}</small>
        </div>
    </div>
    
    {% if not driver or driver.status != 'active' %}
    <!-- Not Active Driver -->
    <div class="alert alert-warning">
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h5>Access Restricted</h5>
            <p class="mb-0">Your driver profile must be approved before you can manage duties.</p>
            <a href="{{ url_for('driver.profile') }}" class="btn btn-warning mt-2">
                <i class="fas fa-user-edit me-2"></i>View Profile
            </a>
        </div>
    </div>
    
    {% elif active_duty %}
    <!-- Active Duty - End Duty Form -->
    <div class="card border-success mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-play-circle me-2"></i>Active Duty</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-6">
                    <strong>Vehicle:</strong><br>
                    <span class="badge bg-info fs-6">{{ active_duty.vehicle.registration_number }}</span>
                </div>
                <div class="col-6">
                    <strong>Started:</strong><br>
                    <span class="text-success">{{ active_duty.start_time.strftime('%H:%M') if active_duty.start_time else 'N/A' }}</span>
                </div>
            </div>
            
            {% if active_duty.start_photo %}
            <div class="mb-3">
                <strong>Start Duty Photo:</strong><br>
                <img src="/uploads/{{ active_duty.start_photo }}" class="img-fluid rounded mt-2" style="max-height: 200px;">
            </div>
            {% endif %}
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Duration:</strong> 
                <span id="duty-duration">Calculating...</span>
            </div>
        </div>
    </div>
    
    <!-- End Duty Form -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-stop-circle me-2"></i>End Duty</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('driver.end_duty') }}" enctype="multipart/form-data">
                <!-- Basic Duty Information -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="end_odometer" class="form-label">Ending Odometer Reading *</label>
                        <input type="number" class="form-control" name="end_odometer" id="end_odometer" 
                               min="{{ active_duty.start_odometer or 0 }}" step="0.1" required>
                        <small class="text-muted">
                            Started at: {{ active_duty.start_odometer or 'Not recorded' }}
                        </small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="trip_count" class="form-label">Number of Trips *</label>
                        <input type="number" class="form-control" name="trip_count" id="trip_count" 
                               min="0" required>
                    </div>
                </div>
                
                <!-- Comprehensive Financial Section -->
                <div class="card bg-light mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>Revenue & Collections</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="cash_collected" class="form-label">Cash Collected *</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="cash_collected" id="cash_collected" 
                                           min="0" step="0.01" required>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="qr_payment" class="form-label">QR/UPI Payments</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="qr_payment" id="qr_payment" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="outside_cash" class="form-label">Outside Cash</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="outside_cash" id="outside_cash" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Company Expenses Section -->
                <div class="card bg-light mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-receipt me-2"></i>Company Expenses</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="operator_bill" class="form-label">Operator Bill *</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="operator_bill" id="operator_bill" 
                                           min="0" step="0.01" required>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="toll" class="form-label">Toll Charges</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="toll" id="toll" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="petrol_expenses" class="form-label">Petrol/Diesel</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="petrol_expenses" id="petrol_expenses" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="gas_expenses" class="form-label">Gas Expenses</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="gas_expenses" id="gas_expenses" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="other_expenses" class="form-label">Other Expenses</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="other_expenses" id="other_expenses" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Driver Salary & Deductions Section -->
                <div class="card bg-light mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>Driver Salary & Deductions</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="company_pay" class="form-label">Company Pay *</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="company_pay" id="company_pay" 
                                           min="0" step="0.01" required>
                                </div>
                                <small class="text-muted">Base salary/guarantee</small>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="advance" class="form-label">Advance</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="advance" id="advance" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="driver_expenses" class="form-label">Driver Expenses</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="driver_expenses" id="driver_expenses" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="pass_deduction" class="form-label">Pass Deduction</label>
                                <div class="input-group">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" name="pass_deduction" id="pass_deduction" 
                                           min="0" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Fuel Information -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="fuel_amount" class="form-label">Fuel Filled (Liters)</label>
                        <input type="number" class="form-control" name="fuel_amount" id="fuel_amount" 
                               min="0" step="0.1" value="0">
                        <small class="text-muted">Amount of fuel filled during duty</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card border-info">
                            <div class="card-body p-2">
                                <h6 class="text-info mb-1"><i class="fas fa-calculator me-2"></i>Live Calculation</h6>
                                <div id="live-calculation">
                                    <small>
                                        <div>Total Earnings: <span id="calc-total-earnings">₹0.00</span></div>
                                        <div>Driver Salary: <span id="calc-driver-salary">₹0.00</span></div>
                                        <div>Company Profit: <span id="calc-company-profit">₹0.00</span></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- End Duty Photo -->
                <div class="mb-3">
                    <label for="end_photo" class="form-label">End Duty Photo *</label>
                    <input type="file" class="form-control" name="end_photo" id="end_photo" 
                           accept="image/*" capture="camera" required>
                    <small class="text-muted">Take a photo to confirm duty completion</small>
                </div>
                
                <!-- Photo Preview -->
                <div id="photo-preview" class="mb-3" style="display: none;">
                    <img id="preview-image" class="img-fluid rounded" style="max-height: 200px;">
                </div>
                
                
                <button type="submit" class="btn btn-danger btn-lg w-100" onclick="return confirm('Are you sure you want to end this duty?')">
                    <i class="fas fa-stop-circle me-2"></i>End Duty
                </button>
            </form>
        </div>
    </div>
    
    {% else %}
    <!-- Start Duty Form -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-play-circle me-2"></i>Start New Duty</h5>
        </div>
        <div class="card-body">
            {% if not available_vehicles %}
            <div class="alert alert-warning text-center py-4">
                <i class="fas fa-car fa-3x mb-3"></i>
                <h5>No Vehicles Available</h5>
                <p class="mb-0">No vehicles are currently available in your branch. Please contact your manager.</p>
            </div>
            {% else %}
            
            <form method="POST" action="{{ url_for('driver.start_duty') }}" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="vehicle_id" class="form-label">Select Vehicle *</label>
                    <select class="form-select" name="vehicle_id" id="vehicle_id" required>
                        <option value="">Choose Vehicle</option>
                        {% for vehicle in available_vehicles %}
                        <option value="{{ vehicle.id }}">
                            {{ vehicle.registration_number }} - {{ vehicle.vehicle_type.title() }}
                            {% if vehicle.model %}({{ vehicle.model }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="start_odometer" class="form-label">Starting Odometer Reading *</label>
                    <input type="number" class="form-control" name="start_odometer" id="start_odometer" 
                           min="0" step="0.1" required>
                    <small class="text-muted" id="last-odometer-info">Enter the current odometer reading</small>
                </div>
                
                <!-- Start Duty Photo -->
                <div class="mb-3">
                    <label for="start_photo" class="form-label">Start Duty Photo *</label>
                    <input type="file" class="form-control" name="start_photo" id="start_photo" 
                           accept="image/*" capture="camera" required>
                    <small class="text-muted">Take a photo with the vehicle to confirm duty start</small>
                </div>
                
                <!-- Photo Preview -->
                <div id="start-photo-preview" class="mb-3" style="display: none;">
                    <img id="start-preview-image" class="img-fluid rounded" style="max-height: 200px;">
                </div>
                
                <!-- Pre-duty Checklist -->
                <div class="card bg-light mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Pre-Duty Checklist</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check_fuel">
                            <label class="form-check-label" for="check_fuel">Vehicle fuel level checked</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check_documents">
                            <label class="form-check-label" for="check_documents">Vehicle documents verified</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="check_condition">
                            <label class="form-check-label" for="check_condition">Vehicle condition inspected</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check_safety">
                            <label class="form-check-label" for="check_safety">Safety equipment present</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success btn-lg w-100" id="start-duty-btn">
                    <i class="fas fa-play me-2"></i>Start Duty
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    
    <!-- Instructions Card -->
    <div class="card border-info mt-4">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Duty Instructions</h6>
        </div>
        <div class="card-body">
            <ul class="mb-0">
                <li><strong>Starting Duty:</strong> Select vehicle, record odometer, take photo</li>
                <li><strong>During Duty:</strong> Collect revenue, count trips, maintain records</li>
                <li><strong>Ending Duty:</strong> Record final odometer, revenue, trips, take end photo</li>
                <li><strong>Important:</strong> Ensure photos are clear and show vehicle registration</li>
                <li><strong>Support:</strong> Contact branch manager for any issues during duty</li>
            </ul>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Photo preview functionality
function setupPhotoPreview(inputId, previewDivId, previewImageId) {
    const input = document.getElementById(inputId);
    const previewDiv = document.getElementById(previewDivId);
    const previewImage = document.getElementById(previewImageId);
    
    if (input && previewDiv && previewImage) {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewDiv.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewDiv.style.display = 'none';
            }
        });
    }
}

// Setup photo previews
setupPhotoPreview('start_photo', 'start-photo-preview', 'start-preview-image');
setupPhotoPreview('end_photo', 'photo-preview', 'preview-image');

// Live tripsheet calculation
function calculateTripsheet() {
    // Get all financial input values
    const cashCollected = parseFloat(document.getElementById('cash_collected')?.value) || 0;
    const qrPayment = parseFloat(document.getElementById('qr_payment')?.value) || 0;
    const outsideCash = parseFloat(document.getElementById('outside_cash')?.value) || 0;
    const operatorBill = parseFloat(document.getElementById('operator_bill')?.value) || 0;
    const toll = parseFloat(document.getElementById('toll')?.value) || 0;
    const petrolExpenses = parseFloat(document.getElementById('petrol_expenses')?.value) || 0;
    const gasExpenses = parseFloat(document.getElementById('gas_expenses')?.value) || 0;
    const otherExpenses = parseFloat(document.getElementById('other_expenses')?.value) || 0;
    const companyPay = parseFloat(document.getElementById('company_pay')?.value) || 0;
    const advance = parseFloat(document.getElementById('advance')?.value) || 0;
    const driverExpenses = parseFloat(document.getElementById('driver_expenses')?.value) || 0;
    const passDeduction = parseFloat(document.getElementById('pass_deduction')?.value) || 0;

    // Perform tripsheet calculations
    const incentive = Math.max(cashCollected - operatorBill, 0);
    const driverSalary = companyPay + incentive - (advance + driverExpenses + passDeduction);
    const totalEarnings = cashCollected + qrPayment + outsideCash;
    const totalExpenses = operatorBill + toll + petrolExpenses + gasExpenses + otherExpenses;
    const companyProfit = totalEarnings - (driverSalary + totalExpenses);

    // Update live calculation display
    const totalEarningsSpan = document.getElementById('calc-total-earnings');
    const driverSalarySpan = document.getElementById('calc-driver-salary');
    const companyProfitSpan = document.getElementById('calc-company-profit');

    if (totalEarningsSpan) totalEarningsSpan.textContent = '₹' + totalEarnings.toLocaleString('en-IN', {minimumFractionDigits: 2});
    if (driverSalarySpan) driverSalarySpan.textContent = '₹' + driverSalary.toLocaleString('en-IN', {minimumFractionDigits: 2});
    if (companyProfitSpan) companyProfitSpan.textContent = '₹' + companyProfit.toLocaleString('en-IN', {minimumFractionDigits: 2});
}

// Setup live calculation listeners for all financial inputs
const financialInputIds = [
    'cash_collected', 'qr_payment', 'outside_cash', 'operator_bill', 'toll',
    'petrol_expenses', 'gas_expenses', 'other_expenses', 'company_pay',
    'advance', 'driver_expenses', 'pass_deduction'
];

financialInputIds.forEach(inputId => {
    const input = document.getElementById(inputId);
    if (input) {
        input.addEventListener('input', calculateTripsheet);
        input.addEventListener('change', calculateTripsheet);
    }
});

// Initial calculation on page load
document.addEventListener('DOMContentLoaded', calculateTripsheet);

// Duty duration calculation
{% if active_duty and active_duty.start_time %}
function updateDuration() {
    const startTime = new Date('{{ active_duty.start_time.isoformat() }}');
    const now = new Date();
    const diff = now - startTime;
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    document.getElementById('duty-duration').textContent = `${hours}h ${minutes}m`;
}

// Update duration every minute
updateDuration();
setInterval(updateDuration, 60000);
{% endif %}

// Checklist validation for start duty
const startDutyBtn = document.getElementById('start-duty-btn');
if (startDutyBtn) {
    const checkboxes = ['check_fuel', 'check_documents', 'check_condition', 'check_safety'];
    
    function validateChecklist() {
        const allChecked = checkboxes.every(id => document.getElementById(id).checked);
        startDutyBtn.disabled = !allChecked;
        
        if (allChecked) {
            startDutyBtn.classList.remove('btn-secondary');
            startDutyBtn.classList.add('btn-success');
        } else {
            startDutyBtn.classList.remove('btn-success');
            startDutyBtn.classList.add('btn-secondary');
        }
    }
    
    checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.addEventListener('change', validateChecklist);
        }
    });
    
    // Initial validation
    validateChecklist();
}

// Auto-fill odometer from last submission
function loadLastValues() {
    const vehicleSelect = document.getElementById('vehicle_id');
    if (vehicleSelect && vehicleSelect.value) {
        fetch(`/driver/duty/last-values/${vehicleSelect.value}`)
            .then(response => response.json())
            .then(data => {
                const startOdometerField = document.getElementById('start_odometer');
                const odometerInfo = document.getElementById('last-odometer-info');
                
                if (data.last_odometer && !startOdometerField.value) {
                    startOdometerField.value = data.last_odometer;
                    if (odometerInfo) odometerInfo.innerHTML = `Last submission: ${data.last_odometer} km`;
                }
            })
            .catch(error => console.log('Could not load last values:', error));
    }
}

// Load last values when vehicle is selected
const vehicleSelect = document.getElementById('vehicle_id');
if (vehicleSelect) {
    vehicleSelect.addEventListener('change', loadLastValues);
    // Load on page load if vehicle is already selected
    if (vehicleSelect.value) {
        setTimeout(loadLastValues, 500);
    }
}

// Distance calculation helper
const startOdo = document.getElementById('start_odometer');
const endOdo = document.getElementById('end_odometer');
if (startOdo && endOdo) {
    endOdo.addEventListener('input', function() {
        const start = parseFloat(startOdo.value) || 0;
        const end = parseFloat(endOdo.value) || 0;
        
        if (end < start) {
            endOdo.setCustomValidity('End reading must be greater than start reading');
        } else {
            endOdo.setCustomValidity('');
        }
    });
}
</script>
{% endblock %}
